<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê¸‰ì‹ì§€ë„ êµì‚¬ì¡°íšŒ</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ê¸‰ì‹ì§€ë„">
<meta name="theme-color" content="#d97642">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(160deg, #3d2817, #5d4037);
    min-height: 100vh;
    padding: 16px 16px 40px;
}
.wrap { max-width: 500px; margin: 0 auto; }
.header {
    background: linear-gradient(135deg, #d97642, #c8622f);
    border-radius: 20px;
    padding: 28px 24px;
    margin-bottom: 16px;
    box-shadow: 0 10px 30px rgba(217,118,66,0.35);
    text-align: center;
}
.header h1 { font-size: 28px; font-weight: 900; color: white; }
.header p  { color: rgba(255,255,255,0.85); font-size: 14px; margin-top: 4px; }
.card {
    background: white;
    border-radius: 16px;
    padding: 22px;
    margin-bottom: 14px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}
.card-title { font-size: 16px; font-weight: 900; color: #3d2817; margin-bottom: 14px; }
.name-input {
    width: 100%;
    padding: 16px 18px;
    border: 2.5px solid #e8d5c4;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    font-family: Arial, sans-serif;
    color: #3d2817;
    outline: none;
    transition: border-color 0.2s;
}
.name-input:focus { border-color: #d97642; }
.month-tabs {
    display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px;
}
.month-tab {
    padding: 10px 18px;
    border-radius: 10px;
    border: 2px solid #e8d5c4;
    background: white;
    font-size: 14px; font-weight: 700;
    cursor: pointer; font-family: Arial, sans-serif;
    color: #8d6e63; transition: all 0.15s;
}
.month-tab.active {
    background: linear-gradient(135deg, #d97642, #c8622f);
    border-color: #d97642; color: white;
}
.stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
.stat { background: #faf8f5; border-radius: 10px; padding: 14px 10px; text-align: center; }
.stat-l { font-size: 11px; color: #8d6e63; font-weight: 700; margin-bottom: 5px; }
.stat-v { font-size: 22px; font-weight: 900; color: #d97642; }
.duty-card {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border-left: 5px solid #2d6a4f;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 10px;
}
.duty-date { font-size: 17px; font-weight: 900; color: #1b4332; margin-bottom: 6px; }
.duty-info { font-size: 14px; font-weight: 600; color: #2d6a4f; margin-bottom: 3px; }
.next-box {
    margin-top: 10px;
    background: #fff8f0;
    border: 2px solid #d97642;
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 13px; font-weight: 700; color: #c8622f;
    line-height: 1.6;
}
.toggle-btn {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: white; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 700; cursor: pointer;
    font-family: Arial, sans-serif; margin-bottom: 14px;
}
.full-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.full-table th {
    background: #f0ebe3; padding: 10px 6px; text-align: center;
    font-weight: 900; border: 1px solid #e8d5c4; color: #3d2817;
}
.full-table td {
    padding: 8px 6px; border: 1px solid #e8d5c4; vertical-align: top;
}
.t-chip {
    display: inline-block; padding: 2px 6px; border-radius: 4px;
    margin: 1px; font-size: 11px; font-weight: 600;
    background: #f5f5f5; color: #3d2817;
}
.t-chip.me {
    background: #fef08a; color: #713f12; font-weight: 900;
    border: 1px solid #fde047;
}
.msg {
    padding: 12px 16px;
    border-radius: 10px;
    margin-bottom: 14px;
    font-size: 14px;
    font-weight: 700;
}
.msg-green { background: #d1fae5; color: #065f46; }
.msg-red { background: #fee2e2; color: #991b1b; }
.msg-orange { background: #fff7ed; color: #9a3412; }
.btn-main { 
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, #d97642, #c8622f);
    color: white; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 700; cursor: pointer;
    font-family: Arial, sans-serif;
}
.btn-refresh {
    padding: 10px 16px;
    background: linear-gradient(135deg, #059669, #047857);
    color: white; border: none; border-radius: 10px;
    font-size: 13px; font-weight: 700; cursor: pointer;
    font-family: Arial, sans-serif;
}
.footer { 
    text-align: center; 
    padding: 20px 0; 
    color: rgba(255,255,255,0.35); 
    font-size: 11px; 
}
</style>
</head>
<body>
<div class="wrap">
    <div class="header">
        <h1>ğŸ½ï¸ ê¸‰ì‹ì§€ë„ êµì‚¬ì¡°íšŒ</h1>
        <p>ê°œì¸ ì¼ì • ì¡°íšŒ ì•±</p>
    </div>

    <div id="msg-area"></div>

    <!-- URL ì…ë ¥ -->
    <div class="card" id="url-card">
        <div class="card-title">ğŸ”— ê´€ë¦¬ì URL ì—°ê²°</div>
        <p style="font-size:13px;color:#666;margin-bottom:12px">ê´€ë¦¬ìì—ê²Œ ë°›ì€ URLì„ ë¶™ì—¬ë„£ê³  ì—°ê²°í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”</p>
        <input type="text" id="url-input" class="name-input" placeholder="https://script.google.com/macros/s/...">
        <button class="btn-main" onclick="connect()" style="margin-top:10px">ğŸ”— ì—°ê²°í•˜ê¸°</button>
    </div>

    <!-- ì´ë¦„ + ì›” ì„ íƒ -->
    <div class="card" id="query-card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <div class="card-title" style="margin:0">ğŸ‘¤ ì´ë¦„ ì…ë ¥</div>
            <button class="btn-refresh" onclick="refreshData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <input type="text" id="name-input" class="name-input" placeholder="ì˜ˆ: í™ê¸¸ë™" oninput="search()">
        <div id="month-area" style="margin-top:10px;"></div>
    </div>

    <div id="result-area"></div>
    <div id="table-area"></div>

    <div class="footer">Designed by Song HwaYoung | Ver 1.0 | 2026. 02. 17</div>
</div>

<script>
var schedules = [];
var selMonth = '';
var tableVisible = false;

window.onload = function() {
    var savedUrl = localStorage.getItem('lunchDutyGasUrl') || '';
    if (savedUrl) {
        document.getElementById('url-input').value = savedUrl;
        showMsg('â³ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'orange');
        var xhr = new XMLHttpRequest();
        xhr.open('GET', savedUrl + '?action=load', true);
        xhr.onload = function() {
            try {
                var json = JSON.parse(xhr.responseText);
                if (json.success && json.data && json.data.length > 0) {
                    schedules = json.data;
                    localStorage.setItem('lunchDutySavedSchedules', JSON.stringify(schedules));
                    showMsg('âœ… ìµœì‹  ë°ì´í„°: ' + schedules.map(function(s){ return s.year+'ë…„ '+s.month+'ì›”'; }).join(', '), 'green');
                    showQueryCard();
                } else {
                    showMsg('âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'orange');
                }
            } catch(e) {
                showMsg('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'red');
            }
        };
        xhr.onerror = function() {
            showMsg('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'red');
        };
        xhr.send();
    }
};

function refreshData() {
    var url = localStorage.getItem('lunchDutyGasUrl');
    if (!url) { 
        showMsg('âŒ URLì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.', 'red'); 
        return; 
    }
    showMsg('â³ ìµœì‹  ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'orange');
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url + '?action=load', true);
    xhr.onload = function() {
        try {
            var json = JSON.parse(xhr.responseText);
            if (json.success && json.data && json.data.length > 0) {
                schedules = json.data;
                localStorage.setItem('lunchDutySavedSchedules', JSON.stringify(schedules));
                showMsg('âœ… ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ!', 'green');
                renderMonthTabs();
                search();
            } else {
                showMsg('âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'orange');
            }
        } catch(e) {
            showMsg('âŒ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', 'red');
        }
    };
    xhr.onerror = function() {
        showMsg('âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'red');
    };
    xhr.send();
}

function connect() {
    var url = document.getElementById('url-input').value.trim();
    if (!url) { showMsg('âŒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'red'); return; }
    localStorage.setItem('lunchDutyGasUrl', url);
    showMsg('â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'orange');

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url + '?action=load', true);
    xhr.onload = function() {
        try {
            var json = JSON.parse(xhr.responseText);
            if (json.success && json.data && json.data.length > 0) {
                schedules = json.data;
                localStorage.setItem('lunchDutySavedSchedules', JSON.stringify(schedules));
                showMsg('âœ… ' + schedules.length + 'ê°œì›” ë°ì´í„° ì—°ê²° ì„±ê³µ!', 'green');
                showQueryCard();
            } else {
                showMsg('âš ï¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ë¨¼ì € ì—…ë¡œë“œí•´ì•¼ í•´ìš”.', 'orange');
            }
        } catch(e) {
            showMsg('âŒ ì—°ê²° ì‹¤íŒ¨. URLì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'red');
        }
    };
    xhr.onerror = function() {
        showMsg('âŒ ì—°ê²° ì‹¤íŒ¨. URLì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'red');
    };
    xhr.send();
}

function showQueryCard() {
    document.getElementById('query-card').style.display = 'block';
    if (!selMonth && schedules.length > 0) {
        var last = schedules[schedules.length-1];
        selMonth = last.year + '-' + last.month;
    }
    renderMonthTabs();
}

function renderMonthTabs() {
    var html = '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
    schedules.forEach(function(s) {
        var key = s.year + '-' + s.month;
        var active = selMonth === key;
        html += '<button onclick="selectMonth(\'' + key + '\')" class="month-tab'+(active?' active':'')+'">' + s.month + 'ì›”</button>';
    });
    html += '</div>';
    document.getElementById('month-area').innerHTML = html;
    search();
}

function selectMonth(key) {
    selMonth = key;
    tableVisible = false;
    renderMonthTabs();
}

function search() {
    var name = document.getElementById('name-input').value.trim();
    var resultArea = document.getElementById('result-area');
    var tableArea = document.getElementById('table-area');
    if (!name || !selMonth) { resultArea.innerHTML = ''; tableArea.innerHTML = ''; return; }

    var parts = selMonth.split('-');
    var y = parseInt(parts[0]), m = parseInt(parts[1]);
    var d = null;
    for (var i=0; i<schedules.length; i++) {
        if (schedules[i].year===y && schedules[i].month===m) { d=schedules[i]; break; }
    }
    if (!d) return;

    var duties = getDuties(d, name);
    var total = getTotalCount(name);

    var html = '<div class="card"><div class="card-title">ğŸ“Š ' + name + ' ì„ ìƒë‹˜ í†µê³„</div>';
    html += '<div class="stats">';
    html += '<div class="stat"><div class="stat-l">ì´ë²ˆ ë‹¬</div><div class="stat-v">' + duties.length + 'ì¼</div></div>';
    html += '<div class="stat"><div class="stat-l">ì „ì²´ ëˆ„ì </div><div class="stat-v">' + total + 'ì¼</div></div>';
    html += '<div class="stat"><div class="stat-l">ì²« ë‹´ë‹¹ì¼</div><div class="stat-v" style="font-size:15px">' + (duties.length>0?duties[0].date:'-') + '</div></div>';
    html += '</div></div>';

    html += '<div class="card"><div class="card-title">ğŸ“‹ ' + m + 'ì›” ë‚´ ë‹´ë‹¹ ì¼ì •</div>';
    if (duties.length === 0) {
        html += '<p style="text-align:center;padding:20px;color:#999">ì´ë²ˆ ë‹¬ ë°°ì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        duties.forEach(function(item) {
            var next = getNext(d, item);
            html += '<div class="duty-card">';
            html += '<div class="duty-date">ğŸ“… ' + item.date + ' (' + item.dow + ')</div>';
            html += '<div class="duty-info">ğŸ« ' + item.grade + ' ê¸‰ì‹ì§€ë„</div>';
            if (item.loc) html += '<div class="duty-info">ğŸ“ ' + item.loc + '</div>';
            if (next) html += '<div class="next-box">ğŸ”„ ë‹¤ìŒ ë‹´ë‹¹: <strong>' + next.name + '</strong> (' + next.date + ')<br>â†’ íŒ»ë§ì„ ' + next.name + ' ì„ ìƒë‹˜ê»˜ ì „ë‹¬í•˜ì„¸ìš”!</div>';
            html += '</div>';
        });
    }
    html += '</div>';
    resultArea.innerHTML = html;

    tableArea.innerHTML = '<div class="card"><div class="card-title">ğŸ“‹ ' + m + 'ì›” ì „ì²´ ë°°ì • ê²°ê³¼</div><button class="toggle-btn" onclick="toggleTable()" id="table-btn">ğŸ“‹ ì „ì²´ ë°°ì • ê²°ê³¼ ë³´ê¸° [í´ë¦­]</button><div id="table-content"></div></div>';
}

function toggleTable() {
    tableVisible = !tableVisible;
    document.getElementById('table-btn').textContent = tableVisible ? 'ğŸ‘¤ ë‚´ ë‹´ë‹¹ì¼ë§Œ ë³´ê¸° [í´ë¦­]' : 'ğŸ“‹ ì „ì²´ ë°°ì • ê²°ê³¼ ë³´ê¸° [í´ë¦­]';
    if (tableVisible) renderTable();
    else document.getElementById('table-content').innerHTML = '';
}

function renderTable() {
    var name = document.getElementById('name-input').value.trim();
    var parts = selMonth.split('-');
    var y = parseInt(parts[0]), m = parseInt(parts[1]);
    var d = null;
    for (var i=0; i<schedules.length; i++) {
        if (schedules[i].year===y && schedules[i].month===m) { d=schedules[i]; break; }
    }
    if (!d) return;
    var duties = getDuties(d, name);
    var myDays = {};
    duties.forEach(function(x){ myDays[x.day]=true; });

    var html = '<div style="overflow-x:auto;margin-top:12px"><table class="full-table"><thead><tr><th>ë‚ ì§œ</th><th>ìš”ì¼</th><th>1í•™ë…„</th><th>2í•™ë…„</th><th>3í•™ë…„</th></tr></thead><tbody>';
    for (var day=1; day<=31; day++) {
        var mm = String(m).padStart(2,'0');
        var dk = y+'-'+mm+'-'+String(day).padStart(2,'0');
        var ds = d.schedule[dk];
        if (!ds) continue;
        var date = new Date(y, m-1, day);
        if (date.getMonth() !== m-1) break;
        var dow = date.getDay();
        if (dow===0||dow===6) continue;
        var dowStr = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dow];
        var isMyDay = myDays[day];
        html += '<tr style="background:'+(isMyDay?'#dcfce7':(day%2===0?'white':'#fafafa'))+'">';
        html += '<td style="font-weight:bold;white-space:nowrap">'+m+'ì›”'+day+'ì¼'+(isMyDay?' â­':'')+'</td>';
        html += '<td style="text-align:center">'+dowStr+'</td>';
        ['grade1','grade2','grade3'].forEach(function(gId) {
            html += '<td>';
            var assigns = (ds[gId]||[]).filter(function(a){ return a&&a.teacherId; });
            if (assigns.length===0) { html += '<span style="color:#ccc">-</span>'; }
            else assigns.forEach(function(a) {
                var t = null;
                for (var i=0; i<d.teachers.length; i++) { if (d.teachers[i].id===a.teacherId) { t=d.teachers[i]; break; } }
                if (!t) return;
                var loc = a.location==='stairs'?'(ê³„ë‹¨)':a.location==='entrance'?'(ì…êµ¬)':'';
                var isMe = t.name===name;
                html += '<span class="t-chip'+(isMe?' me':'')+'">'+t.name+loc+'</span>';
            });
            html += '</td>';
        });
        html += '</tr>';
    }
    html += '</tbody></table></div><p style="font-size:11px;color:#999;margin-top:6px">â­ì´ˆë¡=ë‚´ë‹´ë‹¹ | ğŸŸ¡ë…¸ë€ì´ë¦„=ë‚˜</p>';
    document.getElementById('table-content').innerHTML = html;
}

function getDuties(d, name) {
    var res = [];
    Object.keys(d.schedule).forEach(function(dk) {
        var parts = dk.split('-');
        var y=parseInt(parts[0]), m=parseInt(parts[1]), day=parseInt(parts[2]);
        if (y!==d.year||m!==d.month) return;
        var ds = d.schedule[dk];
        ['grade1','grade2','grade3'].forEach(function(gId, gi) {
            (ds[gId]||[]).forEach(function(a, idx) {
                if (!a||!a.teacherId) return;
                var t=null;
                for (var i=0; i<d.teachers.length; i++) { if (d.teachers[i].id===a.teacherId) { t=d.teachers[i]; break; } }
                if (!t||t.name!==name) return;
                var dow = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(y,m-1,day).getDay()];
                var loc = a.location==='stairs'?'ê³„ë‹¨':a.location==='entrance'?'ê¸‰ì‹ì†Œ ì…êµ¬':'';
                res.push({day:day, date:m+'ì›” '+day+'ì¼', dow:dow, grade:(gi+1)+'í•™ë…„', loc:loc, gId:gId, idx:idx});
            });
        });
    });
    return res.sort(function(a,b){ return a.day-b.day; });
}

function getNext(d, curr) {
    var mm = String(d.month).padStart(2,'0');
    for (var day=curr.day+1; day<=31; day++) {
        var dk = d.year+'-'+mm+'-'+String(day).padStart(2,'0');
        var ds = d.schedule[dk];
        if (!ds) continue;
        var a = (ds[curr.gId]||[])[curr.idx];
        if (a&&a.teacherId) {
            var t=null;
            for (var i=0; i<d.teachers.length; i++) { if (d.teachers[i].id===a.teacherId) { t=d.teachers[i]; break; } }
            if (t) return {name:t.name, date:d.month+'ì›” '+day+'ì¼'};
        }
    }
    return null;
}

function getTotalCount(name) {
    var n=0;
    schedules.forEach(function(d) {
        Object.values(d.schedule).forEach(function(ds) {
            ['grade1','grade2','grade3'].forEach(function(gId) {
                (ds[gId]||[]).forEach(function(a) {
                    if (!a||!a.teacherId) return;
                    var t=null;
                    for (var i=0; i<d.teachers.length; i++) { if (d.teachers[i].id===a.teacherId) { t=d.teachers[i]; break; } }
                    if (t&&t.name===name) n++;
                });
            });
        });
    });
    return n;
}

function showMsg(text, type) {
    document.getElementById('msg-area').innerHTML = '<div class="msg msg-'+type+'">'+text+'</div>';
    setTimeout(function(){ document.getElementById('msg-area').innerHTML=''; }, 4000);
}
</script>
</body>
</html>
