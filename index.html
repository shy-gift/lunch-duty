<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>급식지도표 작성프로그램 - 관리자용</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #3d2817 0%, #5d4037 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 25px;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #d97642, #c8622f);
            border-radius: 24px;
            padding: 40px 50px;
            margin-bottom: 10px;
            box-shadow: 0 25px 50px rgba(217, 118, 66, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 42px;
            font-weight: 900;
            color: white;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
        }

        .admin-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f5e6d3, #e8d5c4);
            color: #5d4037;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 900;
            font-size: 14px;
            margin-top: 10px;
            border: 1px solid rgba(93, 64, 55, 0.2);
        }

        .panel {
            background: linear-gradient(135deg, #faf8f5 0%, #f5f1eb 100%);
            border-radius: 24px;
            padding: 35px;
            box-shadow: 0 20px 60px rgba(61, 40, 23, 0.15);
            border: 1px solid rgba(93, 64, 55, 0.08);
        }

        .panel h2 {
            font-size: 24px;
            margin-bottom: 25px;
            color: #3d2817;
            font-weight: 900;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h3 {
            font-size: 18px;
            font-weight: 900;
            color: #3d2817;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8d5c4;
        }

        .upload-box {
            border: 3px solid;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .upload-box.green {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-color: #2d6a4f;
        }

        .upload-box.beige {
            background: linear-gradient(135deg, #f5f1eb, #e8d5c4);
            border-color: #8d6e63;
        }

        .upload-box.blue {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-color: #1976d2;
        }

        .box-title {
            font-size: 16px;
            font-weight: 900;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .green .box-title { color: #1b4332; }
        .beige .box-title { color: #3d2817; }
        .blue .box-title { color: #0d47a1; }

        .file-input, .text-input, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid;
            border-radius: 12px;
            font-size: 14px;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .green .file-input { border-color: #81c784; background: white; }
        .beige textarea { border-color: #bcaaa4; background: white; }
        .blue .file-input { border-color: #64b5f6; background: white; }

        textarea {
            min-height: 120px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
        }

        .text-input {
            border-color: #e8d5c4;
            background: white;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #d97642, #c8622f);
            color: white;
            box-shadow: 0 4px 12px rgba(217, 118, 66, 0.2);
            width: 100%;
            margin-top: 12px;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(217, 118, 66, 0.35);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6d4c41, #5d4037);
            color: white;
            box-shadow: 0 4px 12px rgba(93, 64, 55, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #8d6e63, #6d4c41);
            color: white;
        }

        .teacher-list {
            background: #f5f1eb;
            border-radius: 12px;
            padding: 15px;
            max-height: 500px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            display: flex;
            gap: 12px;
        }

        .teacher-item {
            background: white;
            padding: 18px 20px;
            border-radius: 10px;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e8d5c4;
            transition: all 0.2s;
            min-width: 150px;
            max-width: 150px;
            flex-shrink: 0;
        }

        .teacher-item:hover {
            box-shadow: 0 4px 12px rgba(217, 118, 66, 0.2);
            transform: translateY(-4px);
        }

        .teacher-name {
            font-weight: 700;
            color: #3d2817;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 8px;
            text-align: center;
            white-space: normal;
            word-break: keep-all;
        }

        .teacher-name:hover {
            color: #d97642;
        }

        .teacher-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #d97642;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .teacher-counts {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #8d6e63;
            text-align: center;
            margin-bottom: 6px;
            white-space: normal;
            line-height: 1.4;
        }

        .teacher-total {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 900;
            color: #d97642;
            text-align: center;
            margin-bottom: 8px;
        }

        .btn-edit, .btn-save, .btn-cancel {
            padding: 6px 14px;
            font-size: 11px;
            margin-top: 6px;
            border-radius: 8px;
            width: 100%;
        }

        .btn-edit {
            background: #fff7ed;
            color: #c8622f;
            border: 2px solid #d97642;
        }

        .btn-save {
            background: #2d6a4f;
            color: white;
            border: none;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
            border: none;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #faf8f5);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(61, 40, 23, 0.08);
            border: 1px solid rgba(232, 213, 196, 0.3);
        }

        .stat-label {
            font-size: 12px;
            color: #8d6e63;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: #d97642;
            font-family: 'JetBrains Mono', monospace;
        }

        .calendar-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(61, 40, 23, 0.08);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .month-display {
            font-size: 24px;
            font-weight: 900;
            color: #3d2817;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 900;
            font-size: 13px;
            padding: 10px;
            background: #f5f1eb;
            border-radius: 8px;
            color: #5d4037;
        }

        .calendar-day-header.sunday { color: #c62828; }
        .calendar-day-header.saturday { color: #1565c0; }

        .calendar-day-cell {
            background: white;
            border: 2px solid #e8d5c4;
            border-radius: 12px;
            padding: 10px;
            min-height: 90px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 118, 66, 0.2);
        }

        .calendar-day-cell.weekend {
            background: #f8fafc;
        }

        .calendar-day-cell.has-schedule {
            border-color: #d97642;
            border-width: 3px;
            box-shadow: 0 2px 8px rgba(217, 118, 66, 0.15);
        }

        .calendar-day-cell.excluded {
            background: #fff3e0;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .calendar-day-cell.empty {
            background: #fafafa;
            border-color: #f1f5f9;
            cursor: default;
        }

        .calendar-day-number {
            font-weight: 900;
            font-size: 15px;
            margin-bottom: 6px;
            color: #3d2817;
        }

        .calendar-day-number.sunday { color: #c62828; }
        .calendar-day-number.saturday { color: #1565c0; }

        .calendar-assignment {
            background: #fff8f0;
            border: 1px solid #e8d5c4;
            padding: 4px 6px;
            border-radius: 6px;
            font-size: 10px;
            margin-bottom: 3px;
            color: #5d4037;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .excluded-label {
            font-size: 10px;
            color: #f97316;
            font-weight: 700;
            text-align: center;
            margin-top: 10px;
        }

        .today-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, #d97642, #c8622f);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            box-shadow: 0 2px 8px rgba(217, 118, 66, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .modal h3 {
            font-size: 24px;
            font-weight: 900;
            color: #3d2817;
            margin-bottom: 20px;
        }

        .modal-close {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
        }

        .grade-section {
            margin-bottom: 25px;
            background: #faf8f5;
            padding: 20px;
            border-radius: 12px;
        }

        .grade-section-title {
            font-size: 18px;
            font-weight: 900;
            color: #3d2817;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d97642;
        }

        .teacher-slot {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #2d6a4f;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 10px;
            font-weight: 700;
            color: #1b4332;
            position: relative;
            cursor: pointer;
        }

        .teacher-slot:hover {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
        }

        .teacher-slot.empty {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #94a3b8;
            font-style: italic;
        }

        .teacher-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #faf8f5, #f5f1eb);
            border: 3px solid #d97642;
            border-radius: 12px;
            padding: 15px;
            margin-top: 8px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 400px;
            overflow-y: auto;
        }

        .teacher-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e8d5c4;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .teacher-selector-label {
            font-size: 12px;
            font-weight: 700;
            color: #8d6e63;
            margin-bottom: 8px;
        }

        .teacher-selector-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .teacher-selector-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: white;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .teacher-selector-item:hover {
            background: #fff8f0;
            border-color: #d97642;
        }

        .teacher-selector-name {
            font-weight: 700;
            color: #3d2817;
        }

        .teacher-selector-count {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: #d97642;
            font-size: 12px;
            background: #fff8f0;
            padding: 4px 10px;
            border-radius: 10px;
        }

        .teacher-selector-clear, .teacher-selector-close {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
        }

        .teacher-selector-clear {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #dc2626;
        }

        .teacher-selector-close {
            background: #e8d5c4;
            color: #5d4037;
            border: none;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            grid-column: 1 / -1;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #059669;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #dc2626;
        }

        .help-text {
            font-size: 12px;
            color: #8d6e63;
            margin-top: 8px;
            line-height: 1.5;
        }

        .green .help-text { color: #2d6a4f; }
        .beige .help-text { color: #8d6e63; }
        .blue .help-text { color: #1565c0; }

        .month-config {
            max-height: 200px;
            overflow-y: auto;
            background: #f5f1eb;
            border-radius: 12px;
            padding: 15px;
        }

        .month-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e8d5c4;
        }

        .month-label {
            font-weight: 700;
            color: #5d4037;
            min-width: 60px;
            font-size: 15px;
        }

        .month-row input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #e8d5c4;
            border-radius: 8px;
            text-align: center;
            font-weight: 700;
            font-size: 14px;
        }

        .excluded-dates-list {
            background: #f5f1eb;
            border-radius: 10px;
            padding: 12px;
            margin-top: 10px;
        }

        .excluded-date-item {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e8d5c4;
        }

        .remove-date-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d97642;
            border-radius: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function LunchDutyScheduler() {
            // State 정의
            const [teachers, setTeachers] = useState([]);
            const [excludedTeachersInput, setExcludedTeachersInput] = useState('');
            const [schedule, setSchedule] = useState({});
            const [currentDate, setCurrentDate] = useState(new Date());
            const [alert, setAlert] = useState(null);
            const [manualTeacherInput, setManualTeacherInput] = useState('');
            const [excludedDates, setExcludedDates] = useState([]);
            const [newExcludedDate, setNewExcludedDate] = useState('');
            const [selectedDate, setSelectedDate] = useState(null);
            const [editingTeacherId, setEditingTeacherId] = useState(null);
            const [editingTeacherName, setEditingTeacherName] = useState('');
            const [showScheduleUpdateModal, setShowScheduleUpdateModal] = useState(false);
            const [scheduleUpdateDate, setScheduleUpdateDate] = useState('');
            const [pendingScheduleUpdate, setPendingScheduleUpdate] = useState(null);
            const [showTestChecklistModal, setShowTestChecklistModal] = useState(false);
            const [savedSchedules, setSavedSchedules] = useState([]);
            const [showSavedSchedulesModal, setShowSavedSchedulesModal] = useState(false);
            const [confirmedMonths, setConfirmedMonths] = useState(new Set());
            const [monthlyTeacherCount, setMonthlyTeacherCount] = useState({
                1: 2, 2: 1, 3: 2, 4: 1, 5: 1, 6: 1,
                7: 1, 8: 1, 9: 1, 10: 1, 11: 1, 12: 2
            });
            const [gasUrl, setGasUrl] = useState(() => localStorage.getItem('lunchDutyGasUrl') || '');
            const [gasUploading, setGasUploading] = useState(false);
            
            // 간단한 기간별 배정 상태
            const [showMultiPeriodModal, setShowMultiPeriodModal] = useState(false);
            const [periods, setPeriods] = useState([
                { id: 1, startDate: '', endDate: '', excludedTeachers: '', teachersPerGrade: 2 }
            ]);
            const [periodInfo, setPeriodInfo] = useState({}); // 각 날짜의 기간 설정 정보 저장

            // Google Sheets로 배정 데이터 업로드
            const uploadToSheets = async (data) => {
                if (!gasUrl) return false;
                try {
                    setGasUploading(true);
                    const res = await fetch(gasUrl, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'save', data })
                    });
                    const json = await res.json();
                    setGasUploading(false);
                    return json.success;
                } catch(e) {
                    setGasUploading(false);
                    console.error('Google Sheets 업로드 실패:', e);
                    return false;
                }
            };

            // localStorage에서 모든 데이터 불러오기
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('lunchDutyAdminComplete');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.teachers) setTeachers(data.teachers);
                        if (data.schedule) setSchedule(data.schedule);
                        if (data.excludedTeachersInput) setExcludedTeachersInput(data.excludedTeachersInput);
                        if (data.excludedDates) setExcludedDates(data.excludedDates);
                        if (data.monthlyTeacherCount) setMonthlyTeacherCount(data.monthlyTeacherCount);
                        if (data.confirmedMonths) setConfirmedMonths(new Set(data.confirmedMonths));
                        
                        // 복원 알림
                        setTimeout(() => {
                            setAlert({ 
                                message: `이전 데이터를 불러왔습니다. (저장 시각: ${new Date(data.savedAt).toLocaleString('ko-KR')})`, 
                                type: 'success' 
                            });
                            setTimeout(() => setAlert(null), 5000);
                        }, 500);
                    }
                    
                    // savedSchedules 별도 불러오기
                    const savedSch = localStorage.getItem('lunchDutySavedSchedules');
                    if (savedSch) {
                        setSavedSchedules(JSON.parse(savedSch));
                    }
                } catch (error) {
                    console.error('데이터 불러오기 실패:', error);
                }
            }, []);

            // 모든 데이터 변경 시 자동 저장
            useEffect(() => {
                if (teachers.length > 0) {
                    try {
                        const data = {
                            teachers,
                            schedule,
                            excludedTeachersInput,
                            excludedDates,
                            monthlyTeacherCount,
                            confirmedMonths: Array.from(confirmedMonths),
                            savedAt: new Date().toISOString()
                        };
                        localStorage.setItem('lunchDutyAdminComplete', JSON.stringify(data));
                    } catch (error) {
                        console.error('데이터 저장 실패:', error);
                    }
                }
            }, [teachers, schedule, excludedTeachersInput, excludedDates, monthlyTeacherCount, confirmedMonths]);

            const grades = [
                { id: 'grade1', name: '1학년', period: 4, order: 3 },
                { id: 'grade3', name: '3학년', period: 3, order: 1 },
                { id: 'grade2', name: '2학년', period: 3, order: 2 }
            ];

            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];

            const getLocalDateString = (year, month, day) => {
                return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            };

            const showAlert = (message, type = 'success') => {
                setAlert({ message, type });
                setTimeout(() => setAlert(null), 4000);
            };

            // 교사 시간표 파일 업로드
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        const filteredData = jsonData.filter(row => {
                            const firstCell = row[0];
                            return firstCell && /^\(\d+\)/.test(String(firstCell));
                        });

                        const teacherData = filteredData.map((row, index) => {
                            const rawName = row[0];
                            const cleanName = String(rawName).replace(/^\(\d+\)/, '').trim();
                            
                            const schedule = {};
                            for (let i = 1; i < row.length; i++) {
                                const value = row[i];
                                if (value) {
                                    const dayIndex = Math.floor((i - 1) / 7);
                                    const period = ((i - 1) % 7) + 1;
                                    const dayName = ['월', '화', '수', '목', '금'][dayIndex];
                                    if (dayName && period <= 7) {
                                        if (!schedule[dayName]) schedule[dayName] = {};
                                        schedule[dayName][period] = value;
                                    }
                                }
                            }
                            
                            return {
                                id: `teacher_${index}`,
                                name: cleanName,
                                schedule: schedule,
                                gradeCounts: { grade1: 0, grade2: 0, grade3: 0, total: 0 },
                                lastLocation: null
                            };
                        });

                        teacherData.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                        setTeachers(teacherData);
                        showAlert(`${teacherData.length}명의 교사 정보를 불러왔습니다.`);
                        
                    } catch (error) {
                        console.error(error);
                        showAlert('파일을 읽는 중 오류가 발생했습니다.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // 시간표 업데이트 (기존 일정 있을 때)
            const handleScheduleUpdate = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (Object.keys(schedule).length === 0) {
                    showAlert('기존 일정이 없습니다. 일반 업로드를 사용하세요.', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                        const filteredData = jsonData.filter(row => {
                            const firstCell = row[0];
                            return firstCell && /^\(\d+\)/.test(String(firstCell));
                        });

                        const newTeacherData = filteredData.map((row, index) => {
                            const rawName = row[0];
                            const cleanName = String(rawName).replace(/^\(\d+\)/, '').trim();
                            
                            const scheduleData = {};
                            for (let i = 1; i < row.length; i++) {
                                const value = row[i];
                                if (value) {
                                    const dayIndex = Math.floor((i - 1) / 7);
                                    const period = ((i - 1) % 7) + 1;
                                    const dayName = ['월', '화', '수', '목', '금'][dayIndex];
                                    if (dayName && period <= 7) {
                                        if (!scheduleData[dayName]) scheduleData[dayName] = {};
                                        scheduleData[dayName][period] = value;
                                    }
                                }
                            }
                            
                            // 기존 교사 찾기
                            const existingTeacher = teachers.find(t => t.name === cleanName);
                            
                            return {
                                id: existingTeacher?.id || `teacher_${index}`,
                                name: cleanName,
                                schedule: scheduleData,
                                gradeCounts: existingTeacher?.gradeCounts || { grade1: 0, grade2: 0, grade3: 0, total: 0 },
                                lastLocation: existingTeacher?.lastLocation || null
                            };
                        });

                        newTeacherData.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                        
                        setPendingScheduleUpdate(newTeacherData);
                        setShowScheduleUpdateModal(true);
                        
                    } catch (error) {
                        console.error(error);
                        showAlert('파일을 읽는 중 오류가 발생했습니다.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // 시간표 업데이트 적용 (시간표만 변경)
            const applyScheduleUpdateOnly = () => {
                if (!pendingScheduleUpdate) return;
                
                setTeachers(pendingScheduleUpdate);
                setShowScheduleUpdateModal(false);
                setPendingScheduleUpdate(null);
                setScheduleUpdateDate('');
                showAlert('시간표가 업데이트되었습니다. 기존 일정은 유지됩니다.');
            };

            // 시간표 업데이트 + 특정 날짜 이후 재배정
            const applyScheduleUpdateWithReassign = () => {
                if (!pendingScheduleUpdate || !scheduleUpdateDate) {
                    showAlert('날짜를 선택하세요.', 'error');
                    return;
                }

                const cutoffDate = new Date(scheduleUpdateDate);
                const cutoffKey = getLocalDateString(cutoffDate.getFullYear(), cutoffDate.getMonth(), cutoffDate.getDate());

                // 시간표 업데이트
                setTeachers(pendingScheduleUpdate);

                // 선택 날짜 이후 일정 삭제
                const newSchedule = {};
                Object.keys(schedule).forEach(dateKey => {
                    if (dateKey < cutoffKey) {
                        newSchedule[dateKey] = schedule[dateKey];
                    }
                });

                setSchedule(newSchedule);
                setShowScheduleUpdateModal(false);
                setPendingScheduleUpdate(null);
                setScheduleUpdateDate('');
                showAlert(`${scheduleUpdateDate} 이후 일정이 삭제되었습니다. 시간표가 업데이트되었습니다. 일정을 다시 생성하세요.`);
            };
            
            // 기간 추가
            const addPeriod = () => {
                const newId = Math.max(...periods.map(p => p.id)) + 1;
                setPeriods([...periods, { id: newId, startDate: '', endDate: '', excludedTeachers: '', teachersPerGrade: 2 }]);
            };
            
            // 기간 삭제
            const removePeriod = (id) => {
                if (periods.length === 1) {
                    showAlert('최소 1개의 기간은 필요합니다.', 'error');
                    return;
                }
                setPeriods(periods.filter(p => p.id !== id));
            };
            
            // 기간 수정
            const updatePeriod = (id, field, value) => {
                setPeriods(periods.map(p => 
                    p.id === id ? { ...p, [field]: value } : p
                ));
            };
            
            // 여러 기간 배정 생성
            const generateMultiPeriodSchedule = () => {
                // 유효성 검사
                for (const period of periods) {
                    if (!period.startDate || !period.endDate) {
                        showAlert(`기간 ${period.id}: 시작일과 종료일을 입력하세요.`, 'error');
                        return;
                    }
                    const start = new Date(period.startDate);
                    const end = new Date(period.endDate);
                    if (start > end) {
                        showAlert(`기간 ${period.id}: 시작일이 종료일보다 늦습니다.`, 'error');
                        return;
                    }
                }
                
                const newSchedule = {...schedule};
                let totalGenerated = 0;
                
                // 각 기간별로 배정
                for (const period of periods) {
                    const excludedNames = [
                        ...excludedTeachersInput.split(',').map(n => n.trim()).filter(n => n.length > 0),
                        ...period.excludedTeachers.split(',').map(n => n.trim()).filter(n => n.length > 0)
                    ];
                    
                    const availableTeachers = teachers.filter(teacher => {
                        return !excludedNames.includes(teacher.name) && Object.keys(teacher.schedule || {}).length > 0;
                    });
                    
                    if (availableTeachers.length === 0) {
                        showAlert(`기간 ${period.id}: 배정 가능한 교사가 없습니다.`, 'error');
                        return;
                    }
                    
                    // 이 기간의 학년당 교사 수
                    const teachersPerGrade = period.teachersPerGrade || 1;
                    
                    const startDate = new Date(period.startDate);
                    const endDate = new Date(period.endDate);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dayOfWeek = d.getDay();
                        if (dayOfWeek === 0 || dayOfWeek === 6) continue;
                        
                        const dateKey = getLocalDateString(d.getFullYear(), d.getMonth(), d.getDate());
                        const isExcluded = excludedDates.some(exDate => exDate === dateKey);
                        if (isExcluded) continue;
                        
                        const daySchedule = {};
                        
                        grades.forEach(grade => {
                            const assignments = [];
                            
                            for (let slotIndex = 0; slotIndex < teachersPerGrade; slotIndex++) {
                                const location = slotIndex === 0 ? 'stairs' : 'entrance';
                                const dayName = ['일', '월', '화', '수', '목', '금', '토'][dayOfWeek];
                                const periodNum = grade.period;
                                
                                const available = availableTeachers.filter(teacher => {
                                    const hasClass = teacher.schedule?.[dayName]?.[periodNum];
                                    return !hasClass;
                                });
                                
                                if (available.length === 0) {
                                    assignments.push({ teacherId: null, location });
                                    continue;
                                }
                                
                                available.sort((a, b) => {
                                    const aTotal = a.gradeCounts?.total || 0;
                                    const bTotal = b.gradeCounts?.total || 0;
                                    if (aTotal !== bTotal) return aTotal - bTotal;
                                    
                                    const aLastLoc = a.lastLocation === location ? 1 : 0;
                                    const bLastLoc = b.lastLocation === location ? 1 : 0;
                                    return aLastLoc - bLastLoc;
                                });
                                
                                const selectedTeacher = available[0];
                                assignments.push({
                                    teacherId: selectedTeacher.id,
                                    location
                                });
                                
                                selectedTeacher.gradeCounts = selectedTeacher.gradeCounts || { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                                selectedTeacher.gradeCounts[grade.id]++;
                                selectedTeacher.gradeCounts.total++;
                                selectedTeacher.lastLocation = location;
                            }
                            
                            daySchedule[grade.id] = assignments;
                        });
                        
                        newSchedule[dateKey] = daySchedule;
                        totalGenerated++;
                    }
                }
                
                setSchedule(newSchedule);
                setTeachers([...teachers]);
                setShowMultiPeriodModal(false);
                setPeriods([{ id: 1, startDate: '', endDate: '', excludedTeachers: '', teachersPerGrade: 2 }]);
                showAlert(`${totalGenerated}일의 배정이 생성되었습니다. 누적 횟수가 업데이트되었습니다.`);
            };

            // 현재 월 시간표 확정 및 저장
            const saveCurrentMonthSchedule = () => {
                if (Object.keys(schedule).length === 0) {
                    showAlert('저장할 일정이 없습니다.', 'error');
                    return;
                }

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                
                const scheduleKey = `${year}-${String(month).padStart(2, '0')}`;
                
                // 현재 월의 일정만 필터링
                const currentMonthSchedule = {};
                Object.keys(schedule).forEach(dateKey => {
                    const [y, m] = dateKey.split('-').map(Number);
                    if (y === year && m === month) {
                        currentMonthSchedule[dateKey] = schedule[dateKey];
                    }
                });
                
                if (Object.keys(currentMonthSchedule).length === 0) {
                    showAlert(`${year}년 ${month}월 일정이 없습니다.`, 'error');
                    return;
                }
                
                // 이미 저장된 월인지 확인
                const existingIndex = savedSchedules.findIndex(s => s.key === scheduleKey);
                
                const savedData = {
                    key: scheduleKey,
                    year: year,
                    month: month,
                    label: `${year}년 ${month}월`,
                    schedule: currentMonthSchedule,
                    teachers: teachers,
                    excludedDates: excludedDates,
                    teacherCount: monthlyTeacherCount[month],
                    savedAt: new Date().toISOString()
                };

                // 같은 월이 있으면 덮어쓰기, 없으면 추가
                let newSavedSchedules;
                if (existingIndex >= 0) {
                    // 기존 데이터 덮어쓰기 (이전 버전 삭제)
                    newSavedSchedules = [...savedSchedules];
                    newSavedSchedules[existingIndex] = savedData;
                    showAlert(`${year}년 ${month}월 시간표가 업데이트되었습니다.`);
                } else {
                    // 새로 추가 (누적하지 않음)
                    newSavedSchedules = [...savedSchedules, savedData];
                    showAlert(`${year}년 ${month}월 시간표가 저장되었습니다.`);
                }

                // 날짜순 정렬
                newSavedSchedules.sort((a, b) => b.key.localeCompare(a.key));

                setSavedSchedules(newSavedSchedules);
                localStorage.setItem('lunchDutySavedSchedules', JSON.stringify(newSavedSchedules));
                
                // 누적횟수 자동 업데이트
                setTimeout(() => {
                    const savedCounts = {};
                    newSavedSchedules.forEach(savedData => {
                        Object.values(savedData.schedule).forEach(day => {
                            Object.entries(day).forEach(([gradeId, assignments]) => {
                                assignments.forEach(assignment => {
                                    if (assignment && assignment.teacherId) {
                                        const teacherId = assignment.teacherId;
                                        if (!savedCounts[teacherId]) {
                                            savedCounts[teacherId] = { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                                        }
                                        savedCounts[teacherId][gradeId]++;
                                        savedCounts[teacherId].total++;
                                    }
                                });
                            });
                        });
                    });
                    
                    const updatedTeachers = teachers.map(teacher => ({
                        ...teacher,
                        gradeCounts: savedCounts[teacher.id] || { grade1: 0, grade2: 0, grade3: 0, total: 0 }
                    }));
                    
                    setTeachers(updatedTeachers);
                }, 100);
            };

            // 확정된 시간표 기반으로 누적횟수 계산
            const calculateTotalCountsFromSaved = () => {
                const counts = {};
                
                // 모든 저장된 시간표에서 카운트
                savedSchedules.forEach(savedData => {
                    Object.values(savedData.schedule).forEach(day => {
                        Object.entries(day).forEach(([gradeId, assignments]) => {
                            assignments.forEach(assignment => {
                                if (assignment && assignment.teacherId) {
                                    const teacherId = assignment.teacherId;
                                    if (!counts[teacherId]) {
                                        counts[teacherId] = { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                                    }
                                    counts[teacherId][gradeId]++;
                                    counts[teacherId].total++;
                                }
                            });
                        });
                    });
                });
                
                return counts;
            };

            // 교사 목록에 누적횟수 업데이트
            const updateTeacherCountsFromSaved = () => {
                const savedCounts = calculateTotalCountsFromSaved();
                
                const updatedTeachers = teachers.map(teacher => {
                    const counts = savedCounts[teacher.id] || { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                    return {
                        ...teacher,
                        gradeCounts: counts
                    };
                });
                
                setTeachers(updatedTeachers);
                showAlert('확정된 시간표 기반으로 누적횟수를 업데이트했습니다.');
            };

            // 저장된 시간표 불러오기
            const loadSavedSchedule = (savedData) => {
                setSchedule(savedData.schedule);
                setTeachers(savedData.teachers);
                setExcludedDates(savedData.excludedDates);
                setCurrentDate(new Date(savedData.year, savedData.month - 1, 1));
                setShowSavedSchedulesModal(false);
                showAlert(`${savedData.label} 시간표를 불러왔습니다.`);
            };

            // 저장된 시간표 삭제
            const deleteSavedSchedule = (scheduleKey) => {
                if (!confirm('정말 삭제하시겠습니까?')) return;
                
                const newSavedSchedules = savedSchedules.filter(s => s.key !== scheduleKey);
                setSavedSchedules(newSavedSchedules);
                localStorage.setItem('lunchDutySavedSchedules', JSON.stringify(newSavedSchedules));
                
                // 누적횟수 재계산
                setTimeout(() => {
                    const savedCounts = {};
                    newSavedSchedules.forEach(savedData => {
                        Object.values(savedData.schedule).forEach(day => {
                            Object.entries(day).forEach(([gradeId, assignments]) => {
                                assignments.forEach(assignment => {
                                    if (assignment && assignment.teacherId) {
                                        const teacherId = assignment.teacherId;
                                        if (!savedCounts[teacherId]) {
                                            savedCounts[teacherId] = { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                                        }
                                        savedCounts[teacherId][gradeId]++;
                                        savedCounts[teacherId].total++;
                                    }
                                });
                            });
                        });
                    });
                    
                    const updatedTeachers = teachers.map(teacher => ({
                        ...teacher,
                        gradeCounts: savedCounts[teacher.id] || { grade1: 0, grade2: 0, grade3: 0, total: 0 }
                    }));
                    
                    setTeachers(updatedTeachers);
                }, 100);
                
                showAlert('저장된 시간표가 삭제되었습니다.');
            };

            // 직접 입력
            const handleManualInput = () => {
                const names = manualTeacherInput.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                if (names.length === 0) {
                    showAlert('최소 1명 이상의 교사 이름을 입력하세요.', 'error');
                    return;
                }

                const teacherData = names.map((name, index) => ({
                    id: `teacher_${index}`,
                    name: name,
                    schedule: {},
                    gradeCounts: { grade1: 0, grade2: 0, grade3: 0, total: 0 },
                    lastLocation: null
                }));

                teacherData.sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                setTeachers(teacherData);
                showAlert(`${teacherData.length}명의 교사를 등록했습니다.`);
                setManualTeacherInput('');
            };

            // 기존 급식지도표 불러오기
            const handleScheduleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const scheduleSheet = workbook.Sheets['급식지도 일정'];
                        if (!scheduleSheet) {
                            showAlert('급식지도 일정 시트를 찾을 수 없습니다.', 'error');
                            return;
                        }

                        const scheduleData = XLSX.utils.sheet_to_json(scheduleSheet, { defval: '' });
                        
                        const newSchedule = {};
                        const teacherCounts = {};
                        const teacherNamesSet = new Set();

                        scheduleData.forEach(row => {
                            const dateStr = row['날짜'];
                            if (!dateStr) return;

                            const match = dateStr.match(/(\d+)월\s*(\d+)일/);
                            if (!match) return;

                            const month = parseInt(match[1]);
                            const day = parseInt(match[2]);
                            const year = currentDate.getFullYear();
                            const dateKey = getLocalDateString(year, month - 1, day);

                            if (!newSchedule[dateKey]) {
                                newSchedule[dateKey] = {};
                            }

                            grades.forEach(grade => {
                                const assignments = [];
                                let idx = 1;
                                while (true) {
                                    const key = `${grade.name} 담당${idx}`;
                                    if (!row[key]) break;
                                    
                                    const teacherName = row[key];
                                    if (teacherName && teacherName !== '미배정') {
                                        const cleanName = teacherName.replace(/\s*\([^)]*\)\s*/g, '').trim();
                                        teacherNamesSet.add(cleanName);
                                        
                                        const location = teacherName.includes('(계단)') ? 'stairs' : 
                                                       teacherName.includes('(급식소') ? 'entrance' : null;
                                        
                                        assignments.push({ teacherId: cleanName, location: location });
                                        
                                        if (!teacherCounts[cleanName]) {
                                            teacherCounts[cleanName] = { grade1: 0, grade2: 0, grade3: 0, total: 0 };
                                        }
                                        teacherCounts[cleanName][grade.id]++;
                                        teacherCounts[cleanName].total++;
                                    } else {
                                        assignments.push({ teacherId: null, location: null });
                                    }
                                    idx++;
                                }
                                
                                if (assignments.length > 0) {
                                    newSchedule[dateKey][grade.id] = assignments;
                                }
                            });
                        });

                        const teacherNames = Array.from(teacherNamesSet).sort((a, b) => a.localeCompare(b, 'ko'));
                        const teacherData = teacherNames.map((name, index) => ({
                            id: `teacher_${Date.now()}_${index}`,
                            name: name,
                            schedule: {},
                            gradeCounts: teacherCounts[name] || { grade1: 0, grade2: 0, grade3: 0, total: 0 },
                            lastLocation: null
                        }));

                        // teacherId를 이름에서 실제 ID로 매핑
                        const nameToIdMap = {};
                        teacherData.forEach(t => {
                            nameToIdMap[t.name] = t.id;
                        });

                        // schedule의 teacherId를 실제 ID로 변경
                        Object.keys(newSchedule).forEach(dateKey => {
                            Object.keys(newSchedule[dateKey]).forEach(gradeId => {
                                newSchedule[dateKey][gradeId] = newSchedule[dateKey][gradeId].map(assignment => {
                                    if (assignment.teacherId && typeof assignment.teacherId === 'string') {
                                        return {
                                            ...assignment,
                                            teacherId: nameToIdMap[assignment.teacherId] || assignment.teacherId
                                        };
                                    }
                                    return assignment;
                                });
                            });
                        });

                        setTeachers(teacherData);
                        setSchedule(newSchedule);
                        showAlert(`${teacherNames.length}명의 교사와 ${Object.keys(newSchedule).length}일의 일정을 불러왔습니다.`);

                    } catch (error) {
                        console.error(error);
                        showAlert('파일을 읽는 중 오류가 발생했습니다.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // 교사 이름 수정
            const startEditingTeacher = (teacherId, currentName) => {
                setEditingTeacherId(teacherId);
                setEditingTeacherName(currentName);
            };

            const saveTeacherName = (teacherId) => {
                if (!editingTeacherName.trim()) {
                    showAlert('이름을 입력하세요.', 'error');
                    return;
                }

                const updatedTeachers = teachers.map(t => 
                    t.id === teacherId ? { ...t, name: editingTeacherName.trim() } : t
                );
                setTeachers(updatedTeachers);
                setEditingTeacherId(null);
                setEditingTeacherName('');
                showAlert('교사 이름이 변경되었습니다.');
            };

            const cancelEditingTeacher = () => {
                setEditingTeacherId(null);
                setEditingTeacherName('');
            };

            // 교사가 특정 시간에 수업이 있는지 확인
            const isTeacherAvailable = (teacher, dayOfWeek, period) => {
                if (!teacher.schedule) return true;
                const dayName = ['월', '화', '수', '목', '금'][dayOfWeek - 1];
                if (!dayName || !teacher.schedule[dayName]) return true;
                return !teacher.schedule[dayName][period];
            };

            // 제외 날짜 추가
            const addExcludedDate = () => {
                if (!newExcludedDate) {
                    showAlert('날짜를 선택하세요.', 'error');
                    return;
                }
                
                const dateObj = new Date(newExcludedDate);
                const dateKey = getLocalDateString(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
                
                if (excludedDates.includes(dateKey)) {
                    showAlert('이미 추가된 날짜입니다.', 'error');
                    return;
                }
                
                setExcludedDates([...excludedDates, dateKey]);
                setNewExcludedDate('');
                showAlert('제외 날짜가 추가되었습니다.');
            };

            const removeExcludedDate = (dateKey) => {
                setExcludedDates(excludedDates.filter(d => d !== dateKey));
                showAlert('제외 날짜가 삭제되었습니다.');
            };

            const isDateExcluded = (dateKey) => {
                return excludedDates.some(excludedKey => {
                    const excluded = excludedKey.split('T')[0];
                    const target = dateKey.split('T')[0];
                    return excluded === target;
                });
            };

            // 한 달 일정 자동 생성
            const generateMonthSchedule = () => {
                if (teachers.length === 0) {
                    showAlert('먼저 교사 명단을 입력하세요.', 'error');
                    return;
                }

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const teachersPerGrade = monthlyTeacherCount[month + 1] || 1;
                
                const excludedTeachers = excludedTeachersInput.split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                const availableTeachers = teachers.filter(t => !excludedTeachers.includes(t.name));

                if (availableTeachers.length === 0) {
                    showAlert('배정 가능한 교사가 없습니다.', 'error');
                    return;
                }

                // 교사별 누적 횟수 초기화
                availableTeachers.forEach(teacher => {
                    teacher.gradeCounts = { ...teacher.gradeCounts };
                });

                const newSchedule = {};
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    const dateKey = getLocalDateString(year, month, day);

                    if (dayOfWeek === 0 || dayOfWeek === 6 || isDateExcluded(dateKey)) {
                        continue;
                    }

                    newSchedule[dateKey] = {};

                    // 전체 누적 횟수(total) 기준으로 정렬
                    const teacherAssignments = availableTeachers.map(teacher => ({
                        teacher: teacher,
                        count: teacher.gradeCounts.total
                    }));

                    grades.forEach(grade => {
                        const assigned = [];
                        const locations = [];

                        // 누적 횟수 기준 정렬, 동일하면 가나다순
                        teacherAssignments.sort((a, b) => {
                            if (a.count !== b.count) {
                                return a.count - b.count;
                            }
                            return a.teacher.name.localeCompare(b.teacher.name, 'ko');
                        });

                        for (let i = 0; i < teachersPerGrade; i++) {
                            let found = false;

                            for (const assignment of teacherAssignments) {
                                const teacher = assignment.teacher;
                                
                                if (isTeacherAvailable(teacher, dayOfWeek, grade.period) && 
                                    !assigned.includes(teacher.id)) {
                                    
                                    let location = null;
                                    if (teachersPerGrade === 2) {
                                        if (i === 0) {
                                            location = teacher.lastLocation === 'stairs' ? 'entrance' : 'stairs';
                                        } else {
                                            location = locations[0] === 'stairs' ? 'entrance' : 'stairs';
                                        }
                                    }
                                    
                                    assigned.push(teacher.id);
                                    locations.push(location);
                                    teacher.gradeCounts[grade.id]++;
                                    teacher.gradeCounts.total++;
                                    teacher.lastLocation = location;
                                    assignment.count++;
                                    found = true;
                                    break;
                                }
                            }

                            if (!found) {
                                assigned.push(null);
                                locations.push(null);
                            }
                        }

                        newSchedule[dateKey][grade.id] = assigned.map((teacherId, idx) => ({
                            teacherId: teacherId,
                            location: locations[idx]
                        }));
                    });
                }

                setSchedule(newSchedule);
                setTeachers([...availableTeachers]);
                showAlert(`${month + 1}월 일정이 생성되었습니다!`);
            };

            // Excel 다운로드
            const exportToExcel = () => {
                if (Object.keys(schedule).length === 0) {
                    showAlert('먼저 일정을 생성해주세요.', 'error');
                    return;
                }

                const month = currentDate.getMonth() + 1;
                const year = currentDate.getFullYear();
                const teachersPerGrade = monthlyTeacherCount[month] || 1;

                const ws_data = [];
                ws_data.push([`${year}년 ${month}월 급식지도 배정표`]);
                ws_data.push([]);
                
                const headers = ['날짜', '요일'];
                grades.forEach(grade => {
                    for (let i = 1; i <= teachersPerGrade; i++) {
                        headers.push(`${grade.name} 담당${i}`);
                    }
                });
                ws_data.push(headers);

                const sortedDates = Object.keys(schedule).sort();

                sortedDates.forEach(dateKey => {
                    const date = new Date(dateKey + 'T00:00:00');
                    const dayOfWeek = dayNames[date.getDay()];
                    const formattedDate = `${date.getMonth() + 1}월 ${date.getDate()}일`;

                    const row = [formattedDate, dayOfWeek];

                    grades.forEach(grade => {
                        const assigned = schedule[dateKey][grade.id] || [];
                        const teacherCount = assigned.filter(a => a && (a.teacherId || a)).length;
                        
                        for (let i = 0; i < teachersPerGrade; i++) {
                            const assignment = assigned[i];
                            
                            if (!assignment) {
                                row.push('미배정');
                                continue;
                            }
                            
                            const teacherId = assignment.teacherId || assignment;
                            const location = assignment.location;
                            const teacher = teachers.find(t => t.id === teacherId);
                            
                            if (!teacher) {
                                row.push('미배정');
                                continue;
                            }
                            
                            let name = teacher.name;
                            // 1명일 때는 위치 표시 안 함
                            if (teacherCount > 1) {
                                if (location === 'stairs') name += '\n(계단)';
                                else if (location === 'entrance') name += '\n(급식소 입구)';
                            }
                            
                            row.push(name);
                        }
                    });

                    ws_data.push(row);
                });

                // 교사별 누적횟수 시트
                const teacherStatsData = [
                    [`${year}년 ${month}월 교사별 급식지도 누적 횟수`],
                    [],
                    ['교사명', '1학년', '2학년', '3학년', '전체']
                ];
                
                const sortedTeachers = [...teachers].sort((a, b) => a.name.localeCompare(b.name, 'ko'));
                sortedTeachers.forEach(teacher => {
                    teacherStatsData.push([
                        teacher.name,
                        teacher.gradeCounts.grade1,
                        teacher.gradeCounts.grade2,
                        teacher.gradeCounts.grade3,
                        teacher.gradeCounts.total
                    ]);
                });

                const wb = XLSX.utils.book_new();
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const colWidths = [{ wch: 15 }, { wch: 8 }];
                for (let i = 0; i < grades.length * teachersPerGrade; i++) {
                    colWidths.push({ wch: 20 });
                }
                ws['!cols'] = colWidths;
                
                const rowHeights = [{ hpx: 35 }, { hpx: 10 }, { hpx: 28 }];
                for (let i = 0; i < sortedDates.length; i++) {
                    rowHeights.push({ hpx: 35 });
                }
                ws['!rows'] = rowHeights;
                
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } }];
                
                ws['!pageSetup'] = {
                    paperSize: 9,
                    orientation: 'landscape',
                    fitToWidth: 1,
                    fitToHeight: 0
                };
                ws['!margins'] = {
                    left: 0.5, right: 0.5,
                    top: 0.75, bottom: 0.75,
                    header: 0.3, footer: 0.3
                };
                
                XLSX.utils.book_append_sheet(wb, ws, '급식지도 일정');

                const wsStats = XLSX.utils.aoa_to_sheet(teacherStatsData);
                wsStats['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 12 }];
                wsStats['!rows'] = [{ hpx: 35 }, { hpx: 10 }, { hpx: 28 }];
                for (let i = 0; i < sortedTeachers.length; i++) {
                    wsStats['!rows'].push({ hpx: 25 });
                }
                wsStats['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } }];
                wsStats['!pageSetup'] = {
                    paperSize: 9,
                    orientation: 'portrait',
                    fitToWidth: 1,
                    fitToHeight: 0
                };
                
                XLSX.utils.book_append_sheet(wb, wsStats, '교사별 누적횟수');
                
                const fileName = `${year}년${month}월_급식지도배정_관리자용.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showAlert('Excel 파일이 다운로드되었습니다.');
            };

            // 날짜 변경
            const navigateDate = (direction) => {
                const newDate = new Date(currentDate);
                if (direction === 'prev') {
                    newDate.setMonth(newDate.getMonth() - 1);
                } else {
                    newDate.setMonth(newDate.getMonth() + 1);
                }
                setCurrentDate(newDate);
                
                // 이동한 달의 저장된 시간표 자동 불러오기
                setTimeout(() => {
                    const newYear = newDate.getFullYear();
                    const newMonth = newDate.getMonth() + 1;
                    const scheduleKey = `${newYear}-${String(newMonth).padStart(2, '0')}`;
                    const savedData = savedSchedules.find(s => s.key === scheduleKey);
                    
                    if (savedData) {
                        // 저장된 시간표가 있으면 자동으로 불러오기
                        setSchedule(savedData.schedule);
                        setTeachers(savedData.teachers);
                        setExcludedDates(savedData.excludedDates || []);
                        showAlert(`${newYear}년 ${newMonth}월 저장된 시간표를 불러왔습니다.`);
                    } else {
                        // 저장된 시간표가 없으면 해당 월의 배정만 표시 (다른 달 배정은 숨김)
                        const filteredSchedule = {};
                        Object.keys(schedule).forEach(dateKey => {
                            const [y, m] = dateKey.split('-').map(Number);
                            if (y === newYear && m === newMonth) {
                                filteredSchedule[dateKey] = schedule[dateKey];
                            }
                        });
                        setSchedule(filteredSchedule);
                    }
                }, 100);
            };

            // 교사 선택 컴포넌트
            function TeacherSlotWithSelector({ assignment, slotIndex, dateKey, gradeId, allAssignments }) {
                const [showSelector, setShowSelector] = useState(false);
                const [searchTerm, setSearchTerm] = useState('');

                const teacherId = assignment?.teacherId || assignment;
                const location = assignment?.location;
                const teacher = teachers.find(t => t.id === teacherId);

                const getRecommendedTeachers = () => {
                    const date = new Date(dateKey);
                    const dayOfWeek = date.getDay();
                    const grade = grades.find(g => g.id === gradeId);
                    
                    return teachers
                        .filter(t => isTeacherAvailable(t, dayOfWeek, grade.period))
                        .sort((a, b) => a.gradeCounts.total - b.gradeCounts.total)
                        .slice(0, 10);
                };

                const filteredTeachers = searchTerm
                    ? teachers.filter(t => t.name.includes(searchTerm))
                    : getRecommendedTeachers();

                const changeTeacher = (newTeacherId) => {
                    const newSchedule = { ...schedule };
                    const oldAssignment = newSchedule[dateKey][gradeId][slotIndex];
                    const oldTeacherId = oldAssignment?.teacherId || oldAssignment;
                    
                    if (oldTeacherId) {
                        const oldTeacher = teachers.find(t => t.id === oldTeacherId);
                        const grade = grades.find(g => g.id === gradeId);
                        if (oldTeacher && grade) {
                            oldTeacher.gradeCounts[grade.id] = Math.max(0, oldTeacher.gradeCounts[grade.id] - 1);
                            oldTeacher.gradeCounts.total = Math.max(0, oldTeacher.gradeCounts.total - 1);
                        }
                    }
                    
                    if (newTeacherId) {
                        const newTeacher = teachers.find(t => t.id === newTeacherId);
                        const grade = grades.find(g => g.id === gradeId);
                        if (newTeacher && grade) {
                            newTeacher.gradeCounts[grade.id]++;
                            newTeacher.gradeCounts.total++;
                        }
                        
                        const location = oldAssignment?.location || null;
                        newSchedule[dateKey][gradeId][slotIndex] = {
                            teacherId: newTeacherId,
                            location: location
                        };
                        
                        if (location) {
                            newTeacher.lastLocation = location;
                        }
                    } else {
                        newSchedule[dateKey][gradeId][slotIndex] = {
                            teacherId: null,
                            location: oldAssignment?.location || null
                        };
                    }
                    
                    setSchedule(newSchedule);
                    setTeachers([...teachers]);
                    setShowSelector(false);
                    setSearchTerm('');
                    showAlert('교사가 변경되었습니다. 학년별 누적 횟수가 업데이트되었습니다.');
                };

                // 1명일 때는 위치 표시 안 함
                const assignmentCount = allAssignments?.filter(a => a && a.teacherId).length || 0;
                let locationLabel = '';
                if (assignmentCount > 1) {
                    if (location === 'stairs') locationLabel = ' (계단)';
                    else if (location === 'entrance') locationLabel = ' (급식소 입구)';
                }

                return (
                    <div style={{position: 'relative', marginBottom: '14px'}}>
                        <div
                            className={`teacher-slot ${teacher ? '' : 'empty'}`}
                            onClick={() => setShowSelector(!showSelector)}
                        >
                            {teacher ? `👤 ${teacher.name}${locationLabel} (총 ${teacher.gradeCounts.total}회)` : '미배정 - 클릭하여 선택'}
                        </div>
                        
                        {showSelector && (
                            <div className="teacher-selector-dropdown" onClick={(e) => e.stopPropagation()}>
                                <div style={{marginBottom: '12px'}}>
                                    <input
                                        type="text"
                                        placeholder="교사 이름 검색..."
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="teacher-search-input"
                                        autoFocus
                                    />
                                </div>
                                
                                <div className="teacher-selector-label">
                                    {searchTerm ? '검색 결과' : '추천 교사 (시간표 가능 + 적은 횟수순)'}
                                    {assignmentCount > 1 && location && <span style={{marginLeft: '10px', color: '#d97642', fontWeight: 900}}>{locationLabel}</span>}
                                </div>
                                
                                <div className="teacher-selector-list">
                                    {filteredTeachers.length === 0 ? (
                                        <div style={{textAlign: 'center', padding: '20px', color: '#94a3b8'}}>
                                            {searchTerm ? '검색 결과가 없습니다' : '배치 가능한 교사가 없습니다'}
                                        </div>
                                    ) : (
                                        filteredTeachers.map(t => (
                                            <div
                                                key={t.id}
                                                className="teacher-selector-item"
                                                onClick={() => changeTeacher(t.id)}
                                            >
                                                <span className="teacher-selector-name">{t.name}</span>
                                                <span className="teacher-selector-count">
                                                    총 {t.gradeCounts.total}회 (1:{t.gradeCounts.grade1} 2:{t.gradeCounts.grade2} 3:{t.gradeCounts.grade3})
                                                </span>
                                            </div>
                                        ))
                                    )}
                                </div>
                                
                                {teacher && (
                                    <button
                                        className="teacher-selector-clear"
                                        onClick={() => changeTeacher(null)}
                                    >
                                        배정 취소
                                    </button>
                                )}
                                
                                <button
                                    className="teacher-selector-close"
                                    onClick={() => setShowSelector(false)}
                                >
                                    닫기
                                </button>
                            </div>
                        )}
                    </div>
                );
            }

            // 달력 렌더링
            const renderCalendar = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthKey = `${year}-${month + 1}`;
                const isConfirmed = confirmedMonths.has(monthKey);
                const hasSchedule = Object.keys(schedule).some(dateKey => {
                    const [y, m] = dateKey.split('-').map(Number);
                    return y === year && m === month + 1;
                });
                
                const confirmMonth = () => {
                    const newConfirmed = new Set(confirmedMonths);
                    newConfirmed.add(monthKey);
                    setConfirmedMonths(newConfirmed);
                    showAlert(`${year}년 ${month + 1}월 일정이 확정되었습니다.`);
                };
                
                const unconfirmMonth = () => {
                    if (confirm(`${year}년 ${month + 1}월 확정을 취소하시겠습니까?\n\n달력의 배정만 지워지고, 저장된 시간표는 유지됩니다.`)) {
                        const newConfirmed = new Set(confirmedMonths);
                        newConfirmed.delete(monthKey);
                        setConfirmedMonths(newConfirmed);
                        
                        // savedSchedules는 그대로 유지 (삭제하지 않음)
                        // 사용자가 "저장된 시간표 보기"에서 다시 불러올 수 있음
                        
                        // 현재 달력에서 해당 월 일정만 삭제
                        const newSchedule = {};
                        Object.keys(schedule).forEach(dateKey => {
                            const [y, m] = dateKey.split('-').map(Number);
                            if (!(y === year && m === month + 1)) {
                                newSchedule[dateKey] = schedule[dateKey];
                            }
                        });
                        setSchedule(newSchedule);
                        
                        // 누적횟수는 savedSchedules 기준으로 유지 (변경 없음)
                        // 확정 취소해도 저장된 배정은 남아있으므로 누적횟수도 유지
                        
                        showAlert(`${year}년 ${month + 1}월 확정이 취소되었습니다. 저장된 시간표에서 언제든 불러올 수 있습니다.`);
                    }
                };
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

                const calendarDays = [];
                for (let i = 0; i < firstDay; i++) {
                    calendarDays.push(null);
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    calendarDays.push(day);
                }

                return (
                    <div className="calendar-container fade-in">
                        <div className="calendar-header">
                            <div className="month-display">
                                {year}년 {month + 1}월
                            </div>
                            <div className="nav-buttons">
                                <button className="btn btn-secondary" onClick={() => navigateDate('prev')}>
                                    ← 이전 달
                                </button>
                                <button className="btn btn-secondary" onClick={() => navigateDate('next')}>
                                    다음 달 →
                                </button>
                            </div>
                        </div>

                        <div style={{marginBottom: '25px', display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                            <button 
                                className="btn btn-primary" 
                                onClick={generateMonthSchedule}
                                style={{fontSize: '16px', padding: '16px', flex: '1 1 300px'}}
                                disabled={isConfirmed}
                            >
                                📅 한 달 일정 자동 생성 (균등 배분)
                            </button>
                            
                            {/* 여러 기간 배정 버튼 */}
                            <button 
                                className="btn" 
                                onClick={() => setShowMultiPeriodModal(true)}
                                style={{
                                    fontSize: '16px', 
                                    padding: '16px', 
                                    flex: '1 1 200px',
                                    background: 'linear-gradient(135deg, #7c3aed, #6d28d9)',
                                    color: 'white'
                                }}
                                disabled={isConfirmed}
                            >
                                📆 기간별 배정
                            </button>
                            
                            {hasSchedule && !isConfirmed && (
                                <button 
                                    className="btn" 
                                    onClick={confirmMonth}
                                    style={{
                                        fontSize: '16px', 
                                        padding: '16px', 
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #2d6a4f, #1b4332)',
                                        color: 'white'
                                    }}
                                >
                                    ✓ 확정
                                </button>
                            )}
                            
                            {isConfirmed && (
                                <button 
                                    className="btn" 
                                    onClick={unconfirmMonth}
                                    style={{
                                        fontSize: '16px', 
                                        padding: '16px', 
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                        color: 'white'
                                    }}
                                >
                                    ↩️ 확정 취소
                                </button>
                            )}

                            {isConfirmed && (
                                <button
                                    className="btn"
                                    onClick={() => {
                                        const scheduleKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                                        const data = savedSchedules.find(s => s.key === scheduleKey);
                                        if (!data) { alert('저장된 배정 데이터가 없습니다.'); return; }
                                        const json = JSON.stringify(data, null, 2);
                                        const blob = new Blob([json], { type: 'application/json' });
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `급식지도_${year}년${month+1}월_배정결과.json`;
                                        a.click();
                                        URL.revokeObjectURL(url);
                                        showAlert(`${year}년 ${month+1}월 배정 결과를 내보냈습니다. 카카오톡으로 교사들에게 전송하세요!`);
                                    }}
                                    style={{
                                        fontSize: '16px',
                                        padding: '16px',
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #1d4ed8, #1e40af)',
                                        color: 'white'
                                    }}
                                >
                                    📤 배정 결과 내보내기
                                </button>
                            )}

                            {isConfirmed && (
                                <button
                                    className="btn"
                                    onClick={() => {
                                        const date = prompt('교체할 날짜를 입력하세요 (예: 5 또는 05)');
                                        if (!date) return;
                                        const day = parseInt(date);
                                        if (isNaN(day) || day < 1 || day > 31) {
                                            alert('올바른 날짜를 입력하세요 (1-31)');
                                            return;
                                        }
                                        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                                        if (!schedule[dateKey]) {
                                            alert(`${month+1}월 ${day}일은 배정이 없습니다.`);
                                            return;
                                        }
                                        
                                        const oldName = prompt('교체할 교사 이름을 입력하세요');
                                        if (!oldName) return;
                                        const newName = prompt('새로운 교사 이름을 입력하세요');
                                        if (!newName) return;
                                        
                                        // 교사 목록에서 찾기
                                        const oldTeacher = teachers.find(t => t.name === oldName.trim());
                                        const newTeacher = teachers.find(t => t.name === newName.trim());
                                        
                                        if (!oldTeacher) {
                                            alert(`"${oldName}" 교사를 찾을 수 없습니다.`);
                                            return;
                                        }
                                        if (!newTeacher) {
                                            alert(`"${newName}" 교사를 찾을 수 없습니다.`);
                                            return;
                                        }
                                        
                                        // 해당 날짜의 배정에서 교체
                                        let replaced = false;
                                        const daySchedule = schedule[dateKey];
                                        ['grade1', 'grade2', 'grade3'].forEach(gradeId => {
                                            if (daySchedule[gradeId]) {
                                                daySchedule[gradeId].forEach((assignment, idx) => {
                                                    if (assignment && assignment.teacherId === oldTeacher.id) {
                                                        daySchedule[gradeId][idx] = {
                                                            ...assignment,
                                                            teacherId: newTeacher.id
                                                        };
                                                        replaced = true;
                                                    }
                                                });
                                            }
                                        });
                                        
                                        if (replaced) {
                                            setSchedule({...schedule});
                                            saveAllData();
                                            showAlert(`✅ ${month+1}월 ${day}일: ${oldName} → ${newName} 교체 완료! Google Sheets로 공유 버튼을 다시 눌러주세요.`);
                                        } else {
                                            alert(`${month+1}월 ${day}일에 "${oldName}" 교사 배정이 없습니다.`);
                                        }
                                    }}
                                    style={{
                                        fontSize: '16px',
                                        padding: '16px',
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #f59e0b, #d97706)',
                                        color: 'white'
                                    }}
                                >
                                    🔄 교사 긴급 교체
                                </button>
                            )}

                            {isConfirmed && (
                                <button
                                    className="btn"
                                    disabled={!gasUrl || gasUploading}
                                    onClick={async () => {
                                        const scheduleKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                                        const data = savedSchedules.find(s => s.key === scheduleKey);
                                        if (!data) { showAlert('저장된 배정 데이터가 없습니다.', 'error'); return; }
                                        const ok = await uploadToSheets(data);
                                        if (ok) {
                                            showAlert(`✅ ${year}년 ${month+1}월 배정 결과를 Google Sheets에 업로드했습니다! 교사들이 QR코드로 바로 조회할 수 있습니다.`);
                                        } else {
                                            showAlert('❌ 업로드 실패. Apps Script URL을 확인해주세요.', 'error');
                                        }
                                    }}
                                    style={{
                                        fontSize: '16px',
                                        padding: '16px',
                                        flex: '1 1 200px',
                                        background: gasUrl ? 'linear-gradient(135deg, #059669, #047857)' : '#9ca3af',
                                        color: 'white'
                                    }}
                                >
                                    {gasUploading ? '⏳ 업로드 중...' : '☁️ Google Sheets로 공유'}
                                </button>
                            )}

                            {/* 저장된 시간표 보기 - 항상 표시 */}
                            {savedSchedules.length > 0 && (
                                <button 
                                    className="btn" 
                                    onClick={() => setShowSavedSchedulesModal(true)}
                                    style={{
                                        fontSize: '16px', 
                                        padding: '16px', 
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #0891b2, #0e7490)',
                                        color: 'white'
                                    }}
                                >
                                    📋 저장된 시간표 보기 ({savedSchedules.length})
                                </button>
                            )}
                            
                            {/* 확정 및 저장 버튼 */}
                            {hasSchedule && !isConfirmed && (
                                <button 
                                    className="btn" 
                                    onClick={saveCurrentMonthSchedule}
                                    style={{
                                        fontSize: '16px', 
                                        padding: '16px', 
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #2d6a4f, #1b4332)',
                                        color: 'white'
                                    }}
                                >
                                    💾 {month + 1}월 시간표 확정 및 저장
                                </button>
                            )}
                            
                            {/* Excel 다운로드 버튼 */}
                            {hasSchedule && (
                                <button 
                                    className="btn" 
                                    onClick={exportToExcel}
                                    style={{
                                        fontSize: '16px', 
                                        padding: '16px', 
                                        flex: '1 1 200px',
                                        background: 'linear-gradient(135deg, #16a34a, #15803d)',
                                        color: 'white'
                                    }}
                                >
                                    📥 {month + 1}월 관리자용 다운로드
                                </button>
                            )}

                            {/* Google Apps Script URL 설정 */}
                            <div style={{width:'100%', marginTop:'10px', padding:'16px', background:'#f0fdf4', border:'2px solid #86efac', borderRadius:'12px'}}>
                                <div style={{fontSize:'13px', fontWeight:700, color:'#14532d', marginBottom:'8px'}}>
                                    ☁️ Google Sheets 연동 URL (한 번만 설정)
                                </div>
                                <div style={{display:'flex', gap:'8px'}}>
                                    <input
                                        type="text"
                                        placeholder="Apps Script 웹 앱 URL 붙여넣기"
                                        value={gasUrl}
                                        onChange={e => {
                                            setGasUrl(e.target.value);
                                            localStorage.setItem('lunchDutyGasUrl', e.target.value);
                                        }}
                                        style={{flex:1, padding:'10px 14px', border:'2px solid #86efac', borderRadius:'8px', fontSize:'13px', fontFamily:'inherit'}}
                                    />
                                    <button
                                        onClick={() => { setGasUrl(''); localStorage.removeItem('lunchDutyGasUrl'); }}
                                        style={{padding:'10px 14px', background:'#fee2e2', border:'none', borderRadius:'8px', cursor:'pointer', fontSize:'13px', fontWeight:700, color:'#991b1b'}}
                                    >삭제</button>
                                </div>
                                <div style={{fontSize:'11px', color:'#166534', marginTop:'6px'}}>
                                    💡 Apps Script → 배포 → 웹 앱으로 배포 → URL 복사 후 붙여넣기
                                </div>
                            </div>
                            
                            {isConfirmed && (
                                <div style={{
                                    padding: '12px 20px',
                                    background: 'linear-gradient(135deg, #d1fae5, #a7f3d0)',
                                    border: '2px solid #059669',
                                    borderRadius: '12px',
                                    fontWeight: 900,
                                    color: '#065f46',
                                    flex: '1 1 200px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}>
                                    ✓ 확정된 월
                                </div>
                            )}
                        </div>

                        <div className="calendar-grid" style={{marginBottom: '15px'}}>
                            {dayNames.map((day, idx) => (
                                <div 
                                    key={day} 
                                    className={`calendar-day-header ${idx === 0 ? 'sunday' : idx === 6 ? 'saturday' : ''}`}
                                >
                                    {day}
                                </div>
                            ))}
                        </div>
                        
                        <div className="calendar-grid">
                            {calendarDays.map((day, index) => {
                                if (day === null) {
                                    return <div key={`empty-${index}`} className="calendar-day-cell empty" />;
                                }
                                
                                const date = new Date(year, month, day);
                                const dateKey = getLocalDateString(year, month, day);
                                const dayOfWeek = date.getDay();
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                const hasSchedule = schedule[dateKey];
                                const isExcluded = isDateExcluded(dateKey);
                                const isToday = isCurrentMonth && today.getDate() === day;
                                
                                return (
                                    <div 
                                        key={day}
                                        className={`calendar-day-cell ${isWeekend ? 'weekend' : ''} ${hasSchedule ? 'has-schedule' : ''} ${isExcluded ? 'excluded' : ''}`}
                                        onClick={() => hasSchedule && !isExcluded && setSelectedDate(dateKey)}
                                    >
                                        {isToday && <div className="today-badge">●</div>}
                                        
                                        <div className={`calendar-day-number ${dayOfWeek === 0 ? 'sunday' : dayOfWeek === 6 ? 'saturday' : ''}`}>
                                            {day}
                                        </div>
                                        
                                        {isExcluded && (
                                            <div className="excluded-label">급식 없음</div>
                                        )}
                                        
                                        {hasSchedule && !isExcluded && (
                                            <div>
                                                {grades.map(grade => {
                                                    const assigned = schedule[dateKey][grade.id] || [];
                                                    const teacherNames = assigned
                                                        .map(item => {
                                                            if (!item || !item.teacherId) return null;
                                                            
                                                            // ID로 찾기 시도
                                                            let teacher = teachers.find(t => t.id === item.teacherId);
                                                            
                                                            // ID로 못 찾으면 이름으로 찾기 (Excel 불러오기 대비)
                                                            if (!teacher) {
                                                                teacher = teachers.find(t => t.name === item.teacherId);
                                                            }
                                                            
                                                            if (!teacher) {
                                                                console.log('교사를 찾을 수 없음:', item.teacherId, 'teachers:', teachers.length);
                                                                return null;
                                                            }
                                                            
                                                            let label = teacher.name;
                                                            // 1명일 때는 위치 표시 안 함
                                                            const assignmentCount = assigned.filter(a => a && a.teacherId).length;
                                                            if (assignmentCount > 1) {
                                                                if (item.location === 'stairs') label += '(계)';
                                                                else if (item.location === 'entrance') label += '(입)';
                                                            }
                                                            
                                                            return label;
                                                        })
                                                        .filter(Boolean)
                                                        .join(', ');
                                                    
                                                    if (!teacherNames) return null;
                                                    
                                                    return (
                                                        <div key={grade.id} className="calendar-assignment" title={teacherNames}>
                                                            {grade.name[0]}: {teacherNames.length > 12 ? teacherNames.substring(0, 12) + '...' : teacherNames}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            // 통계
            const scheduleCount = Object.keys(schedule).length;
            const availableTeachers = teachers.filter(t => {
                const excluded = excludedTeachersInput.split('\n').map(name => name.trim());
                return !excluded.includes(t.name);
            });

            return (
                <div className="container">
                    <div className="header fade-in">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start'}}>
                            <div>
                                <h1>🍽️ 급식지도 배정 시스템</h1>
                                <p>중학교 급식지도 교사 자동 배치 및 관리</p>
                                <span className="admin-badge">👑 관리자 전용</span>
                            </div>
                            <button
                                className="btn"
                                onClick={() => setShowTestChecklistModal(true)}
                                style={{
                                    background: 'linear-gradient(135deg, #1976d2, #1565c0)',
                                    color: 'white',
                                    padding: '12px 24px',
                                    fontSize: '14px',
                                    fontWeight: 700,
                                    whiteSpace: 'nowrap'
                                }}
                            >
                                ✅ 테스트 체크리스트
                            </button>
                        </div>
                    </div>

                    {alert && (
                        <div className={`alert alert-${alert.type} fade-in`}>
                            <span style={{fontSize: '20px'}}>
                                {alert.type === 'success' && '✓'}
                                {alert.type === 'error' && '✕'}
                            </span>
                            {alert.message}
                        </div>
                    )}

                    <div className="panel fade-in">
                        <h2>👥 교사 관리</h2>
                        
                        <div className="section">
                            <h3>교사 명단 입력</h3>
                            
                            <div className="upload-box green">
                                <div className="box-title">
                                    <span style={{fontSize: '20px'}}>📊</span>
                                    시간표 업로드
                                </div>
                                
                                <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#2d6a4f', marginBottom: '10px'}}>
                                    📂 교사 시간표 파일 선택
                                </label>
                                
                                <input 
                                    type="file" 
                                    accept=".xlsx,.xls,.csv" 
                                    onChange={handleFileUpload}
                                    className="file-input"
                                />
                                
                                <p className="help-text">
                                    ✅ 교사 이름이 (1)홍길동, (2)박영희 형식<br/>
                                    ✅ 시간표로 수업 없는 시간 우선 배치
                                </p>
                            </div>

                            <div className="upload-box beige">
                                <div className="box-title">
                                    <span style={{fontSize: '20px'}}>✏️</span>
                                    직접 입력 (시간표 없이)
                                </div>
                                
                                <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#5d4037', marginBottom: '10px'}}>
                                    교사 이름 입력 (한 줄에 한 명)
                                </label>
                                
                                <textarea 
                                    value={manualTeacherInput}
                                    onChange={(e) => setManualTeacherInput(e.target.value)}
                                    placeholder="홍길동&#10;박영희&#10;김민수&#10;이서연&#10;..."
                                />
                                
                                <button className="btn btn-primary" onClick={handleManualInput}>
                                    ➕ 교사 등록 (가나다순 정렬)
                                </button>
                                
                                <p className="help-text">
                                    ✅ 이름만 입력, 시간표 불필요<br/>
                                    ⚠️ 수업 시간 고려 없이 순번 배정
                                </p>
                            </div>

                            {teachers.length > 0 && Object.keys(schedule).length > 0 && (
                                <div className="upload-box green" style={{marginTop: '20px', border: '3px solid #f59e0b'}}>
                                    <div className="box-title" style={{color: '#92400e'}}>
                                        <span style={{fontSize: '20px'}}>🔄</span>
                                        시간표 중간 변경 (업데이트)
                                    </div>
                                    
                                    <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#92400e', marginBottom: '10px'}}>
                                        📂 새로운 교사 시간표 파일 선택
                                    </label>
                                    
                                    <input 
                                        type="file" 
                                        accept=".xlsx,.xls,.csv" 
                                        onChange={handleScheduleUpdate}
                                        className="file-input"
                                        style={{borderColor: '#fbbf24'}}
                                        key={`schedule-update-${Date.now()}`}
                                    />
                                    
                                    <p className="help-text" style={{color: '#92400e'}}>
                                        🔧 교사 시간표가 중간에 변경되었을 때 사용<br/>
                                        ✅ 기존 누적 횟수는 유지됩니다<br/>
                                        💡 업로드 후 선택:
                                        <br/>&nbsp;&nbsp;&nbsp;옵션 1: 기존 일정 유지 (시간표만 업데이트)
                                        <br/>&nbsp;&nbsp;&nbsp;옵션 2: 특정 날짜 이후 재배정
                                    </p>
                                </div>
                            )}
                        </div>

                        <div className="section">
                            <h3>급식지도 제외 교사</h3>
                            <textarea
                                value={excludedTeachersInput}
                                onChange={(e) => setExcludedTeachersInput(e.target.value)}
                                placeholder="제외할 교사 이름 입력 (한 줄에 한 명)&#10;예:&#10;박영희&#10;김민수"
                                className="text-input"
                                style={{minHeight: '100px'}}
                            />
                            <p className="help-text">
                                급식지도에서 제외할 교사의 이름을 입력하세요
                            </p>
                        </div>

                        <div className="section">
                            <h3>급식 제외 날짜</h3>
                            <div style={{display: 'flex', gap: '10px', marginBottom: '10px'}}>
                                <input
                                    type="date"
                                    value={newExcludedDate}
                                    onChange={(e) => setNewExcludedDate(e.target.value)}
                                    className="text-input"
                                    style={{flex: 1}}
                                />
                                <button className="btn btn-primary" onClick={addExcludedDate} style={{width: 'auto'}}>
                                    추가
                                </button>
                            </div>
                            
                            {excludedDates.length > 0 && (
                                <div className="excluded-dates-list">
                                    {excludedDates.map(dateKey => {
                                        const date = new Date(dateKey);
                                        const formatted = `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
                                        return (
                                            <div key={dateKey} className="excluded-date-item">
                                                <span>{formatted}</span>
                                                <button className="remove-date-btn" onClick={() => removeExcludedDate(dateKey)}>
                                                    삭제
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>

                        <div className="section">
                            <h3>월별 배정 인원</h3>
                            <div className="month-config">
                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(m => (
                                    <div key={m} className="month-row">
                                        <div className="month-label">{m}월 배정 인원</div>
                                        <input 
                                            type="number"
                                            min="1"
                                            max="5"
                                            value={monthlyTeacherCount[m]}
                                            onChange={(e) => setMonthlyTeacherCount({
                                                ...monthlyTeacherCount,
                                                [m]: parseInt(e.target.value) || 1
                                            })}
                                        />
                                    </div>
                                ))}
                            </div>
                            <p className="help-text" style={{marginTop: '10px'}}>
                                학년당 배정할 교사 수를 설정하세요 (1~5명)
                            </p>
                        </div>

                        {teachers.length > 0 && (
                            <div className="section">
                                <h3>교사 목록 ({teachers.length}명) - 클릭하여 이름 수정</h3>
                                <p className="help-text" style={{marginBottom: '12px'}}>
                                    ← 좌우로 스크롤하여 모든 교사를 확인하세요 →
                                </p>
                                <div className="teacher-list">
                                    {teachers.map(teacher => (
                                        <div key={teacher.id} className="teacher-item">
                                            {editingTeacherId === teacher.id ? (
                                                <>
                                                    <input
                                                        type="text"
                                                        className="teacher-name-input"
                                                        value={editingTeacherName}
                                                        onChange={(e) => setEditingTeacherName(e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && saveTeacherName(teacher.id)}
                                                        autoFocus
                                                    />
                                                    <button className="btn btn-save" onClick={() => saveTeacherName(teacher.id)}>
                                                        저장
                                                    </button>
                                                    <button className="btn btn-cancel" onClick={cancelEditingTeacher}>
                                                        취소
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <div 
                                                        className="teacher-name"
                                                        onClick={() => startEditingTeacher(teacher.id, teacher.name)}
                                                    >
                                                        {teacher.name}
                                                    </div>
                                                    <div className="teacher-total">
                                                        총 {teacher.gradeCounts.total}회
                                                    </div>
                                                    <div className="teacher-counts">
                                                        1학년:{teacher.gradeCounts.grade1}
                                                        <br/>
                                                        2학년:{teacher.gradeCounts.grade2}
                                                        <br/>
                                                        3학년:{teacher.gradeCounts.grade3}
                                                    </div>
                                                    <button 
                                                        className="btn btn-edit" 
                                                        onClick={() => startEditingTeacher(teacher.id, teacher.name)}
                                                    >
                                                        수정
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="panel fade-in">
                        <h2>📆 일정 관리</h2>
                        
                        <div className="stats-bar">
                            <div className="stat-card">
                                <div className="stat-label">전체 교사</div>
                                <div className="stat-value">{teachers.length}</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">배치 가능</div>
                                <div className="stat-value">{availableTeachers.length}</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">일정 생성</div>
                                <div className="stat-value">{scheduleCount}일</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">제외 날짜</div>
                                <div className="stat-value">{excludedDates.length}</div>
                            </div>
                        </div>

                        {renderCalendar()}
                    </div>

                    {selectedDate && (
                        <div className="modal-overlay" onClick={() => setSelectedDate(null)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()}>
                                <h3>
                                    {new Date(selectedDate).getMonth() + 1}월 {new Date(selectedDate).getDate()}일 
                                    ({dayNames[new Date(selectedDate).getDay()]}) 급식지도 배정
                                </h3>
                                
                                {grades.map(grade => {
                                    const assignments = schedule[selectedDate][grade.id] || [];
                                    return (
                                        <div key={grade.id} className="grade-section">
                                            <div className="grade-section-title">
                                                {grade.name} - {grade.period}교시 후
                                            </div>
                                            {assignments.map((assignment, idx) => (
                                                <TeacherSlotWithSelector
                                                    key={idx}
                                                    assignment={assignment}
                                                    slotIndex={idx}
                                                    dateKey={selectedDate}
                                                    gradeId={grade.id}
                                                    allAssignments={assignments}
                                                />
                                            ))}
                                        </div>
                                    );
                                })}
                                
                                <button className="modal-close" onClick={() => setSelectedDate(null)}>
                                    닫기
                                </button>
                            </div>
                        </div>
                    )}

                    {showTestChecklistModal && (
                        <div className="modal-overlay" onClick={() => setShowTestChecklistModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px', maxHeight: '90vh'}}>
                                <h3>✅ 기능 테스트 체크리스트</h3>
                                
                                <div style={{
                                    background: '#f5f1eb',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    maxHeight: '70vh',
                                    overflowY: 'auto'
                                }}>
                                    <div className="grade-section" style={{marginBottom: '20px'}}>
                                        <div className="grade-section-title">📋 기본 기능</div>
                                        <div style={{fontSize: '13px', color: '#5d4037', lineHeight: '1.8'}}>
                                            ☐ 교사 시간표 업로드<br/>
                                            ☐ 교사 직접 입력<br/>
                                            ☐ 교사 이름 수정 (클릭)<br/>
                                            ☐ 제외 교사 설정<br/>
                                            ☐ 제외 날짜 추가/삭제<br/>
                                            ☐ 월별 배정 인원 변경<br/>
                                        </div>
                                    </div>

                                    <div className="grade-section" style={{marginBottom: '20px'}}>
                                        <div className="grade-section-title">📅 일정 생성</div>
                                        <div style={{fontSize: '13px', color: '#5d4037', lineHeight: '1.8'}}>
                                            ☐ 한 달 일정 자동 생성<br/>
                                            ☐ 학년별 누적 횟수 표시<br/>
                                            ☐ 균등 배분 확인 (total 비슷)<br/>
                                            ☐ 계단/급식소 입구 표시<br/>
                                            ☐ 달력에서 날짜 클릭<br/>
                                            ☐ 교사 변경 → 누적 횟수 자동 업데이트<br/>
                                        </div>
                                    </div>

                                    <div className="grade-section" style={{marginBottom: '20px', background: '#fff8f0', border: '2px solid #f59e0b'}}>
                                        <div className="grade-section-title" style={{color: '#92400e'}}>
                                            🔄 시간표 중간 변경 ⭐
                                        </div>
                                        <div style={{fontSize: '13px', color: '#92400e', lineHeight: '1.8'}}>
                                            <strong>옵션 1: 기존 일정 유지</strong><br/>
                                            ☐ 새 시간표 업로드<br/>
                                            ☐ 모달에서 "기존 일정 유지" 선택<br/>
                                            ☐ 달력 일정 그대로 확인<br/>
                                            ☐ 누적 횟수 유지 확인<br/>
                                            <br/>
                                            <strong>옵션 2: 날짜 이후 재배정</strong><br/>
                                            ☐ 새 시간표 업로드<br/>
                                            ☐ 날짜 입력 (예: 2026-03-15)<br/>
                                            ☐ 적용<br/>
                                            ☐ 15일 이전: 유지 ✓<br/>
                                            ☐ 15일 이후: 삭제됨 ✓<br/>
                                            ☐ 재생성으로 새 시간표 반영<br/>
                                        </div>
                                    </div>

                                    <div className="grade-section" style={{marginBottom: '20px'}}>
                                        <div className="grade-section-title">💾 저장/불러오기</div>
                                        <div style={{fontSize: '13px', color: '#5d4037', lineHeight: '1.8'}}>
                                            ☐ "확정 및 저장" 클릭<br/>
                                            ☐ "저장된 시간표 보기" 확인<br/>
                                            ☐ 저장된 카드 정보 확인<br/>
                                            ☐ "불러오기" → 완벽 복원<br/>
                                            ☐ 덮어쓰기 (같은 월 재저장)<br/>
                                            ☐ 삭제 기능<br/>
                                        </div>
                                    </div>

                                    <div className="grade-section" style={{marginBottom: '20px'}}>
                                        <div className="grade-section-title">📥 Excel</div>
                                        <div style={{fontSize: '13px', color: '#5d4037', lineHeight: '1.8'}}>
                                            ☐ Excel 다운로드<br/>
                                            ☐ 시트1: 급식지도 일정<br/>
                                            ☐ 시트2: 학년별 누적횟수<br/>
                                            ☐ (계단), (급식소 입구) 표시<br/>
                                            ☐ A4 인쇄 확인<br/>
                                        </div>
                                    </div>

                                    <div className="grade-section">
                                        <div className="grade-section-title">👥 교사조회용</div>
                                        <div style={{fontSize: '13px', color: '#5d4037', lineHeight: '1.8'}}>
                                            ☐ 파일 업로드<br/>
                                            ☐ 월 선택 (1-12)<br/>
                                            ☐ 이름 입력<br/>
                                            ☐ 달력에 내 담당일 표시<br/>
                                            ☐ 상세 일정 확인<br/>
                                            ☐ "전체 일정 보기" 토글<br/>
                                        </div>
                                    </div>
                                </div>

                                <button 
                                    className="modal-close" 
                                    onClick={() => setShowTestChecklistModal(false)}
                                    style={{marginTop: '20px'}}
                                >
                                    닫기
                                </button>
                            </div>
                        </div>
                    )}

                    {showSavedSchedulesModal && (
                        <div className="modal-overlay" onClick={() => setShowSavedSchedulesModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '700px'}}>
                                <h3>📚 저장된 월별 시간표</h3>
                                
                                {savedSchedules.length === 0 ? (
                                    <div style={{
                                        textAlign: 'center',
                                        padding: '60px 20px',
                                        color: '#8d6e63'
                                    }}>
                                        <div style={{fontSize: '64px', marginBottom: '20px'}}>📭</div>
                                        <p>저장된 시간표가 없습니다.</p>
                                        <p style={{fontSize: '14px', marginTop: '10px'}}>
                                            월별 일정을 생성한 후 "확정 및 저장" 버튼을 클릭하세요.
                                        </p>
                                    </div>
                                ) : (
                                    <div style={{
                                        background: '#f5f1eb',
                                        borderRadius: '12px',
                                        padding: '15px',
                                        maxHeight: '500px',
                                        overflowY: 'auto'
                                    }}>
                                        {savedSchedules.map((saved, index) => {
                                            const savedDate = new Date(saved.savedAt);
                                            const scheduleKeys = Object.keys(saved.schedule);
                                            const totalDays = scheduleKeys.length;
                                            
                                            return (
                                                <div 
                                                    key={saved.key}
                                                    style={{
                                                        background: 'white',
                                                        borderRadius: '12px',
                                                        padding: '20px',
                                                        marginBottom: '15px',
                                                        border: '2px solid #e8d5c4',
                                                        transition: 'all 0.2s'
                                                    }}
                                                    onMouseEnter={(e) => e.currentTarget.style.borderColor = '#d97642'}
                                                    onMouseLeave={(e) => e.currentTarget.style.borderColor = '#e8d5c4'}
                                                >
                                                    <div style={{
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'flex-start',
                                                        marginBottom: '15px'
                                                    }}>
                                                        <div>
                                                            <div style={{
                                                                fontSize: '20px',
                                                                fontWeight: 900,
                                                                color: '#3d2817',
                                                                marginBottom: '8px'
                                                            }}>
                                                                📅 {saved.label}
                                                            </div>
                                                            <div style={{
                                                                fontSize: '13px',
                                                                color: '#8d6e63',
                                                                marginBottom: '4px'
                                                            }}>
                                                                저장일시: {savedDate.toLocaleString('ko-KR')}
                                                            </div>
                                                        </div>
                                                        <div style={{
                                                            background: 'linear-gradient(135deg, #fff8f0, #fef3e7)',
                                                            padding: '8px 16px',
                                                            borderRadius: '10px',
                                                            border: '2px solid #d97642'
                                                        }}>
                                                            <div style={{
                                                                fontSize: '12px',
                                                                color: '#8d6e63',
                                                                fontWeight: 600
                                                            }}>
                                                                배정일수
                                                            </div>
                                                            <div style={{
                                                                fontSize: '24px',
                                                                fontWeight: 900,
                                                                color: '#d97642',
                                                                fontFamily: 'JetBrains Mono, monospace',
                                                                textAlign: 'center'
                                                            }}>
                                                                {totalDays}
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div style={{
                                                        background: '#faf8f5',
                                                        borderRadius: '8px',
                                                        padding: '12px',
                                                        marginBottom: '15px',
                                                        fontSize: '13px',
                                                        color: '#5d4037'
                                                    }}>
                                                        <div style={{marginBottom: '4px'}}>
                                                            👥 교사: {saved.teachers.length}명
                                                        </div>
                                                        <div style={{marginBottom: '4px'}}>
                                                            🏫 학년당 배정: {saved.teacherCount}명
                                                        </div>
                                                        <div>
                                                            🚫 제외 날짜: {saved.excludedDates.length}일
                                                        </div>
                                                    </div>

                                                    <div style={{
                                                        display: 'grid',
                                                        gridTemplateColumns: '1fr 1fr',
                                                        gap: '10px'
                                                    }}>
                                                        <button
                                                            className="btn btn-primary"
                                                            onClick={() => loadSavedSchedule(saved)}
                                                            style={{
                                                                background: 'linear-gradient(135deg, #2d6a4f, #1b4332)',
                                                                padding: '12px',
                                                                fontSize: '14px'
                                                            }}
                                                        >
                                                            ✓ 불러오기
                                                        </button>
                                                        <button
                                                            className="btn"
                                                            onClick={() => deleteSavedSchedule(saved.key)}
                                                            style={{
                                                                background: '#fee2e2',
                                                                color: '#dc2626',
                                                                border: '2px solid #dc2626',
                                                                padding: '12px',
                                                                fontSize: '14px'
                                                            }}
                                                        >
                                                            🗑️ 삭제
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}

                                <button 
                                    className="modal-close" 
                                    onClick={() => setShowSavedSchedulesModal(false)}
                                    style={{marginTop: '20px'}}
                                >
                                    닫기
                                </button>
                            </div>
                        </div>
                    )}

                    {showScheduleUpdateModal && (
                        <div className="modal-overlay" onClick={() => {
                            setShowScheduleUpdateModal(false);
                            setPendingScheduleUpdate(null);
                            setScheduleUpdateDate('');
                        }}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '600px'}}>
                                <h3 style={{color: '#92400e'}}>
                                    🔄 시간표 업데이트 옵션 선택
                                </h3>
                                
                                <div style={{
                                    background: 'linear-gradient(135deg, #fef3c7, #fde68a)',
                                    border: '2px solid #f59e0b',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    marginBottom: '25px'
                                }}>
                                    <div style={{fontSize: '15px', fontWeight: 700, color: '#92400e', marginBottom: '12px'}}>
                                        📊 새 시간표 정보
                                    </div>
                                    <div style={{fontSize: '14px', color: '#78350f'}}>
                                        교사 수: {pendingScheduleUpdate?.length || 0}명<br/>
                                        기존 누적 횟수: 유지됨<br/>
                                        교사 ID: 유지됨
                                    </div>
                                </div>

                                <div className="grade-section" style={{background: '#e8f5e9', border: '2px solid #2d6a4f'}}>
                                    <div style={{fontSize: '18px', fontWeight: 900, color: '#1b4332', marginBottom: '15px'}}>
                                        옵션 1: 기존 일정 유지
                                    </div>
                                    <div style={{fontSize: '14px', color: '#2d6a4f', marginBottom: '15px', lineHeight: '1.6'}}>
                                        ✅ 시간표만 업데이트<br/>
                                        ✅ 기존에 배정된 급식지도 일정은 그대로 유지<br/>
                                        ✅ 누적 횟수 유지<br/>
                                        💡 사용 시기: 시간표가 약간 변경되었지만 이미 배정된 일정을 바꾸고 싶지 않을 때
                                    </div>
                                    <button 
                                        className="btn btn-success"
                                        onClick={applyScheduleUpdateOnly}
                                        style={{width: '100%', background: 'linear-gradient(135deg, #2d6a4f, #1b4332)'}}
                                    >
                                        ✓ 기존 일정 유지 (시간표만 변경)
                                    </button>
                                </div>

                                <div className="grade-section" style={{background: '#fff7ed', border: '2px solid #f59e0b', marginTop: '20px'}}>
                                    <div style={{fontSize: '18px', fontWeight: 900, color: '#92400e', marginBottom: '15px'}}>
                                        옵션 2: 특정 날짜 이후 재배정
                                    </div>
                                    <div style={{fontSize: '14px', color: '#92400e', marginBottom: '15px', lineHeight: '1.6'}}>
                                        🔧 시간표 업데이트<br/>
                                        🗑️ 선택한 날짜 이후의 기존 일정 삭제<br/>
                                        ✅ 선택한 날짜 이전 일정은 유지<br/>
                                        ✅ 누적 횟수 유지<br/>
                                        💡 사용 시기: 시간표가 크게 변경되어 특정 날짜부터 다시 배정해야 할 때
                                    </div>
                                    
                                    <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#92400e', marginBottom: '10px'}}>
                                        📅 이 날짜부터 재배정 (이 날짜 이후 일정 삭제)
                                    </label>
                                    <input 
                                        type="date"
                                        value={scheduleUpdateDate}
                                        onChange={(e) => setScheduleUpdateDate(e.target.value)}
                                        className="text-input"
                                        style={{borderColor: '#fbbf24', marginBottom: '15px'}}
                                    />
                                    
                                    <button 
                                        className="btn btn-primary"
                                        onClick={applyScheduleUpdateWithReassign}
                                        style={{width: '100%', background: 'linear-gradient(135deg, #f59e0b, #d97706)'}}
                                        disabled={!scheduleUpdateDate}
                                    >
                                        ⚠️ 선택한 날짜 이후 재배정
                                    </button>
                                </div>

                                <button 
                                    className="modal-close" 
                                    onClick={() => {
                                        setShowScheduleUpdateModal(false);
                                        setPendingScheduleUpdate(null);
                                        setScheduleUpdateDate('');
                                    }}
                                    style={{marginTop: '20px'}}
                                >
                                    취소
                                </button>
                            </div>
                        </div>
                    )}

                    {/* 여러 기간 배정 모달 */}
                    {showMultiPeriodModal && (
                        <div className="modal-overlay" onClick={() => setShowMultiPeriodModal(false)}>
                            <div className="modal" onClick={(e) => e.stopPropagation()} style={{maxWidth: '700px', maxHeight: '90vh', overflowY: 'auto'}}>
                                <h3 style={{color: '#6d28d9', marginBottom: '20px'}}>
                                    📆 기간별 배정 생성
                                </h3>
                                
                                <div style={{
                                    background: 'linear-gradient(135deg, #f3e8ff, #e9d5ff)',
                                    border: '2px solid #7c3aed',
                                    borderRadius: '12px',
                                    padding: '20px',
                                    marginBottom: '20px'
                                }}>
                                    <div style={{fontSize: '15px', fontWeight: 700, color: '#5b21b6', marginBottom: '12px'}}>
                                        ℹ️ 기간별 배정이란?
                                    </div>
                                    <div style={{fontSize: '14px', color: '#6d28d9', lineHeight: '1.6'}}>
                                        • 여러 기간을 나눠서 각각 다른 제외 교사로 배정<br/>
                                        • <strong>누적 횟수에 자동 포함</strong><br/>
                                        💡 예: 3/1~7(홍길동 제외), 3/8~14(김철수 제외)
                                    </div>
                                </div>

                                {periods.map((period, index) => (
                                    <div key={period.id} className="grade-section" style={{marginBottom: '20px', position: 'relative'}}>
                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '15px'}}>
                                            <h4 style={{color: '#1e293b', margin: 0}}>📍 기간 {index + 1}</h4>
                                            {periods.length > 1 && (
                                                <button 
                                                    onClick={() => removePeriod(period.id)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: '#ef4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontSize: '13px',
                                                        fontWeight: 700
                                                    }}
                                                >
                                                    ✕ 삭제
                                                </button>
                                            )}
                                        </div>
                                        
                                        <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px'}}>
                                            <div>
                                                <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#475569', marginBottom: '8px'}}>
                                                    📅 시작일
                                                </label>
                                                <input 
                                                    type="date" 
                                                    value={period.startDate}
                                                    onChange={(e) => updatePeriod(period.id, 'startDate', e.target.value)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '10px',
                                                        fontSize: '15px',
                                                        border: '2px solid #e2e8f0',
                                                        borderRadius: '8px'
                                                    }}
                                                />
                                            </div>
                                            
                                            <div>
                                                <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#475569', marginBottom: '8px'}}>
                                                    📅 종료일
                                                </label>
                                                <input 
                                                    type="date" 
                                                    value={period.endDate}
                                                    onChange={(e) => updatePeriod(period.id, 'endDate', e.target.value)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '10px',
                                                        fontSize: '15px',
                                                        border: '2px solid #e2e8f0',
                                                        borderRadius: '8px'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                        
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#475569', marginBottom: '8px'}}>
                                            👥 학년당 교사 수
                                        </label>
                                        <select
                                            value={period.teachersPerGrade}
                                            onChange={(e) => updatePeriod(period.id, 'teachersPerGrade', parseInt(e.target.value))}
                                            style={{
                                                width: '100%',
                                                padding: '10px',
                                                fontSize: '15px',
                                                border: '2px solid #e2e8f0',
                                                borderRadius: '8px',
                                                marginBottom: '12px',
                                                background: 'white',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            <option value="1">1명 (계단만)</option>
                                            <option value="2">2명 (계단 + 입구)</option>
                                        </select>
                                        
                                        <label style={{display: 'block', fontSize: '14px', fontWeight: 700, color: '#475569', marginBottom: '8px'}}>
                                            🚫 제외 교사 (쉼표로 구분)
                                        </label>
                                        <input 
                                            type="text" 
                                            value={period.excludedTeachers}
                                            onChange={(e) => updatePeriod(period.id, 'excludedTeachers', e.target.value)}
                                            placeholder="예: 홍길동, 김철수 (비워두면 전체 참여)"
                                            style={{
                                                width: '100%',
                                                padding: '10px',
                                                fontSize: '15px',
                                                border: '2px solid #e2e8f0',
                                                borderRadius: '8px'
                                            }}
                                        />
                                        <div style={{fontSize: '12px', color: '#64748b', marginTop: '6px'}}>
                                            💡 전체 제외 목록과 별개로, 이 기간만 추가 제외
                                        </div>
                                    </div>
                                ))}

                                <button 
                                    onClick={addPeriod}
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        background: '#f1f5f9',
                                        border: '2px dashed #cbd5e1',
                                        borderRadius: '8px',
                                        color: '#475569',
                                        fontSize: '14px',
                                        fontWeight: 700,
                                        cursor: 'pointer',
                                        marginBottom: '20px'
                                    }}
                                >
                                    ➕ 기간 추가
                                </button>

                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            setShowMultiPeriodModal(false);
                                            setPeriods([{ id: 1, startDate: '', endDate: '', excludedTeachers: '', teachersPerGrade: 2 }]);
                                        }}
                                        style={{background: '#64748b'}}
                                    >
                                        취소
                                    </button>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={generateMultiPeriodSchedule}
                                        style={{background: 'linear-gradient(135deg, #7c3aed, #6d28d9)'}}
                                    >
                                        ✓ 전체 배정 생성
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<LunchDutyScheduler />, document.getElementById('root'));
    </script>

<div style="text-align:center; padding: 30px 20px 20px; color: rgba(255,255,255,0.45); font-size: 12px; font-family: 'Noto Sans KR', sans-serif;">
    Designed by Song HwaYoung &nbsp;|&nbsp; Ver 1.0 &nbsp;|&nbsp; 2026. 02. 17
</div>

</body>
</html>
